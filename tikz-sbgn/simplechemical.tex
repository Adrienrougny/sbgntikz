%Copyright 2018 by Adrien Rougny
%This file may be distributed and/or modified under the terms of the GNU General Public License version 3
%See the file LICENSE.txt
\pgfdeclareshape{simplechemical}{

    \savedanchor\northeast{
        \pgf@x = \wd\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner xsep}}
        \advance\pgf@x by 2\pgf@xa
        \pgf@xb=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xb>\pgf@x
            \pgf@x=\pgf@xb
        \fi
        \pgf@y = \ht\pgfnodeparttextbox
        \advance\pgf@y by \dp\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner ysep}}
        \advance\pgf@y by 2\pgf@xa
        \pgf@yb=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yb>\pgf@y
            \pgf@y=\pgf@yb
        \fi
        \ifdim\pgf@y>\pgf@x
            \pgf@x=\pgf@y
        \fi
        \pgf@x = 0.5\pgf@x
        \advance\pgf@x by 0.5\wd\pgfnodeparttextbox
        \pgf@y = 0.5\pgf@y
        \advance\pgf@y by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@y by -0.5\dp\pgfnodeparttextbox
    }

    \savedanchor\southwest{
        \pgf@x = \wd\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner xsep}}
        \advance\pgf@x by 2\pgf@xa
        \pgf@xb=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xb>\pgf@x
            \pgf@x=\pgf@xb
        \fi
        \pgf@y = \ht\pgfnodeparttextbox
        \advance\pgf@y by \dp\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner ysep}}
        \advance\pgf@y by 2\pgf@xa
        \pgf@yb=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yb>\pgf@y
            \pgf@y=\pgf@yb
        \fi
        \ifdim\pgf@y>\pgf@x
            \pgf@x=\pgf@y
        \fi
        \pgf@x = -0.5\pgf@x
        \advance\pgf@x by 0.5\wd\pgfnodeparttextbox
        \pgf@y = -0.5\pgf@y
        \advance\pgf@y by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@y by -0.5\dp\pgfnodeparttextbox
    }

    \foreach \a in {center, north, south, west, east, south west, south east, north east, north west}
    {
        \inheritanchor[from=rectangle]{\a}
    }

    \anchorborder{
        %we put the center of shape at \pgfpointorigin!
        \@tempdima = \pgf@x
        \@tempdimb = \pgf@y
        \pgf@process{\southwest}
        \pgf@xa=\pgf@x
        \pgf@ya=\pgf@y
        \pgf@process{\northeast}
        \pgf@xb=\pgf@x
        \pgf@yb=\pgf@y
        \newdimen\radius
        \radius = 0.5\pgf@yb
        \advance\radius by -0.5\pgf@ya
        \advance\pgf@xa by \radius
        \advance\pgf@xb by -\radius
        \pgf@xc = 0.5\pgf@xa
        \advance\pgf@xc by 0.5\pgf@xb
        \pgf@yc = 0.5\pgf@ya
        \advance\pgf@yc by 0.5\pgf@yb
        \advance\pgf@xa by -\pgf@xc
        \advance\pgf@xb by -\pgf@xc
        \advance\pgf@ya by -\pgf@yc
        \advance\pgf@yb by -\pgf@yc
        \edef\pgf@marshal{%
            \noexpand\belongstocone
            {\pgfpointorigin}%
            {\noexpand\pgfpoint{\the\pgf@xa}{\the\pgf@yb}}%
            {\noexpand\pgfpoint{\the\pgf@xb}{\the\pgf@yb}}%
            {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
        }
        \pgf@process{\pgf@marshal}
        \if@tempswa
            % \pgftext{a}
            \edef\pgf@marshal{
                \noexpand\pgfpointborderrectangle{\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}{\noexpand\pgfpoint{\the\pgf@xb}{\the\pgf@yb}}
            }
            \pgf@process{\pgf@marshal}
        \else
            \edef\pgf@marshal{%
                \noexpand\belongstocone
                {\pgfpointorigin}%
                {\noexpand\pgfpoint{\the\pgf@xb}{\the\pgf@ya}}%
                {\noexpand\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}%
                {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
            }
            \pgf@process{\pgf@marshal}
            \if@tempswa
                % \pgftext{b}
                \edef\pgf@marshal{%
                    \noexpand\pgfpointborderrectangle{\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}{\noexpand\pgfpoint{\the\pgf@xb}{\the\pgf@yb}}
                }
                \pgf@process{\pgf@marshal}
            \else
                \edef\pgf@marshal{%
                    \noexpand\belongstocone
                    {\pgfpointorigin}%
                    {\noexpand\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}%
                    {\noexpand\pgfpoint{\the\pgf@xa}{\the\pgf@yb}}%
                    {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
                }
                \pgf@process{\pgf@marshal}
                \if@tempswa
                    % \pgftext{c}
                    \edef\pgf@marshal{
                        \noexpand\intersectionlinecircle{\noexpand\pgfpointorigin}{\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}{\noexpand\pgfpoint{\the\pgf@xa}{0pt}}{\the\radius}{1}
                    }
                    \pgf@process{\pgf@marshal}
                \else
                    % \pgftext{d}
                    \edef\pgf@marshal{
                        \noexpand\intersectionlinecircle{\noexpand\pgfpointorigin}{\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}{\noexpand\pgfpoint{\the\pgf@xb}{0pt}}{\the\radius}{2}
                    }
                    \pgf@process{\pgf@marshal}
                \fi
            \fi
        \fi
        \advance\pgf@x by \pgf@xc
        \advance\pgf@y by \pgf@yc
    }

    \backgroundpath{
        \pgf@process{\southwest}
        \pgf@xa=\pgf@x
        \pgf@ya=\pgf@y
        % \pgfmathsetlength{\pgf@xc}{\pgfkeysvalueof{/pgf/outer xsep}}
        % \pgfmathsetlength{\pgf@yc}{\pgfkeysvalueof{/pgf/outer ysep}}
        % \advance\pgf@xa by \pgf@xc
        % \advance\pgf@ya by \pgf@yc
        \pgf@process{\northeast}
        \pgf@xb=\pgf@x
        \pgf@yb=\pgf@y
        \newdimen\radius
        \radius = 0.5\pgf@yb
        \advance\radius by -0.5\pgf@ya
        \advance\pgf@xa by \radius
        \advance\pgf@xb by -\radius
        \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
        \pgf@process{\pgfpatharc{90}{-90}{\radius}}
        \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@ya}}
        \pgf@process{\pgfpatharc{270}{90}{\radius}}
        \pgfpathclose
    }

    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffset{0.25}
            \pgf@process{\southwest}
            \pgf@xa=\pgf@x
            \pgf@ya=\pgf@y
            \advance\pgf@xa by 0.5\pgflinewidth
            \advance\pgf@ya by 0.5\pgflinewidth
            \pgf@process{\northeast}
            \pgf@xb=\pgf@x
            \pgf@yb=\pgf@y
            \advance\pgf@xb by -0.5\pgflinewidth
            \advance\pgf@yb by -0.5\pgflinewidth
            \newdimen\radius
            \radius = 0.5\pgf@yb
            \advance\radius by -0.5\pgf@ya
            \pgfmathsetlength{\pgf@yc}{2*\cloneoffset*\radius-\radius}
            \pgfmathsetlength{\pgf@xc}{sqrt(\radius^2-\pgf@yc^2)}
            \pgfmathsetlength{\pgf@yc}{\pgf@ya+\cloneoffset*(\pgf@yb-\pgf@ya)}
            \pgfmathsetlength{\pgf@x}{\pgf@xa+\radius-\pgf@xc}
            \pgfpathmoveto{\pgfpoint{\pgf@x}{\pgf@yc}}
            \pgfmathsetlength{\pgf@x}{\pgf@xb-\radius+\pgf@xc}
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{round(atan2(2*\cloneoffset*\radius-\radius,sqrt(\radius^2-(2*\cloneoffset*\radius-\radius)^2))}
            \pgfpatharc{\pgf@xc}{-90}{\radius}
            \pgfmathsetlength{\pgf@x}{\pgf@xa+\radius}
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@ya}}
            \pgfmathsetlength{\pgf@xc}{-180-\pgf@xc}
            \pgfpatharc{-90}{\pgf@xc}{\radius}
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{stroke, fill}
        \fi
    }
}
