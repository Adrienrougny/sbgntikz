%Copyright 2018 by Adrien Rougny
%This file may be distributed and/or modified under the terms of the GNU General Public License version 3
%See the file LICENSE.txt
\pgfdeclareshape{macromoleculemultimer}{

    \inheritsavedanchors[from=rectangle] % this is nearly a rectangle

    \savedmacro{\scarceratio}{\def\scarceratio{0.12}}

    \savedmacro{\offsetratio}{\def\offsetratio{0.1}}

    \savedmacro\computecoordinates{%
        \pgf@yb = \ht\pgfnodeparttextbox
        \advance\pgf@yb by \dp\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner ysep}}
        \advance\pgf@yb by 2\pgf@xa
        \pgfmathsetlength{\pgf@yb}{\pgf@yb/(1-\offsetratio)}
        \pgf@yc=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yc>\pgf@yb
            \pgf@yb=\pgf@yc
        \fi
        \pgfmathsetlengthmacro\offset{\offsetratio*\pgf@yb}
        \addtosavedmacro\offset
        \pgf@xb=\wd\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner xsep}}
        \advance\pgf@xb by 2\pgf@xa
        \pgf@xc=\pgfkeysvalueof{/pgf/minimum width}
        \advance\pgf@xb by \offset
        \ifdim\pgf@xc>\pgf@xb
            \pgf@xb=\pgf@xc
        \fi
        \advance\pgf@xb by -\offset
        \advance\pgf@yb by -\offset
        \ifdim\pgf@yb>\pgf@xb
            \pgfmathsetlengthmacro\scarceoffset{\scarceratio*\pgf@xb}
        \else
            \pgfmathsetlengthmacro\scarceoffset{\scarceratio*\pgf@yb}
        \fi
        \addtosavedmacro\scarceoffset
        \pgf@xa=-0.5\pgf@xb
        \advance\pgf@xa by 0.5\wd\pgfnodeparttextbox
        \pgf@xc=\pgf@xa %saving for later
        \pgf@ya=0.5\pgf@yb
        \advance\pgf@ya by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@ya by -0.5\dp\pgfnodeparttextbox
        \advance\pgf@ya by -\scarceoffset
        \pgfextract@process\upperwestnorthjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\upperwestnorthjoin}
        \advance\pgf@ya by \scarceoffset
        \advance\pgf@xa by \scarceoffset
        \pgfextract@process\uppernorthwestjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\uppernorthwestjoin}
        \advance\pgf@xa by \pgf@xb
        \pgfmathaddtolength{\pgf@xa}{-2*\scarceoffset}
        \pgfextract@process\uppernortheastjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\uppernortheastjoin}
        \advance\pgf@ya by -\scarceoffset
        \advance\pgf@xa by \scarceoffset
        \pgfextract@process\uppereastnorthjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\uppereastnorthjoin}
        \advance\pgf@ya by -\pgf@yb
        \pgfmathaddtolength{\pgf@ya}{2*\scarceoffset}
        \pgfextract@process\uppereastsouthjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\uppereastsouthjoin}
        \advance\pgf@ya by -\scarceoffset
        \advance\pgf@xa by -\scarceoffset
        \pgfextract@process\uppersoutheastjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\uppersoutheastjoin}
        \pgf@xa=\pgf@xc
        \advance\pgf@xa by \scarceoffset
        \pgfextract@process\uppersouthwestjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\uppersouthwestjoin}
        \advance\pgf@xa by -\scarceoffset
        \advance\pgf@ya by \scarceoffset
        \pgfextract@process\upperwestsouthjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\upperwestsouthjoin}
        \upperwestnorthjoin
        \advance\pgf@x by \offset
        \advance\pgf@y by -\offset
        \pgfextract@process\lowerwestnorthjoin{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
        \addtosavedmacro{\lowerwestnorthjoin}
        \uppernorthwestjoin
        \advance\pgf@x by \offset
        \advance\pgf@y by -\offset
        \pgfextract@process\lowernorthwestjoin{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
        \addtosavedmacro{\lowernorthwestjoin}
        \uppernortheastjoin
        \advance\pgf@x by \offset
        \advance\pgf@y by -\offset
        \pgfextract@process\lowernortheastjoin{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
        \addtosavedmacro{\lowernortheastjoin}
        \uppereastnorthjoin
        \advance\pgf@x by \offset
        \advance\pgf@y by -\offset
        \pgfextract@process\lowereastnorthjoin{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
        \addtosavedmacro{\lowereastnorthjoin}
        \uppereastsouthjoin
        \advance\pgf@x by \offset
        \advance\pgf@y by -\offset
        \pgfextract@process\lowereastsouthjoin{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
        \addtosavedmacro{\lowereastsouthjoin}
        \uppersoutheastjoin
        \advance\pgf@x by \offset
        \advance\pgf@y by -\offset
        \pgfextract@process\lowersoutheastjoin{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
        \addtosavedmacro{\lowersoutheastjoin}
        \uppersouthwestjoin
        \advance\pgf@x by \offset
        \advance\pgf@y by -\offset
        \pgfextract@process\lowersouthwestjoin{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
        \addtosavedmacro{\lowersouthwestjoin}
        \upperwestsouthjoin
        \advance\pgf@x by \offset
        \advance\pgf@y by -\offset
        \pgfextract@process\lowerwestsouthjoin{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
        \addtosavedmacro{\lowerwestsouthjoin}
        \pgf@xa=\offset
        \pgf@xb=\scarceoffset\relax
        \ifdim\pgf@xa>\pgf@xb
            \lowerwestsouthjoin
            \pgf@xc=\pgf@x
            \uppersouthwestjoin
            \pgfextract@process\leftintersection{\pgfpoint{\the\pgf@xc}{\the\pgf@y}}
            \addtosavedmacro{\leftintersection}
            \uppereastnorthjoin
            \pgf@xc=\pgf@x
            \lowernortheastjoin
            \pgfextract@process\rightintersection{\pgfpoint{\the\pgf@xc}{\the\pgf@y}}
            \addtosavedmacro{\rightintersection}
        \else
            \upperwestsouthjoin
            \advance\pgf@x by \scarceoffset
            \pgfextract@process\uppersouthwestcenter{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
            \addtosavedmacro{\uppersouthwestcenter}
            \advance\pgf@x by \offset
            \advance\pgf@y by -\offset
            \pgfextract@process\lowersouthwestcenter{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
            \addtosavedmacro{\lowersouthwestcenter}
            \uppernortheastjoin
            \advance\pgf@y by -\scarceoffset
            \pgfextract@process\uppernortheastcenter{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
            \addtosavedmacro{\uppernortheastcenter}
            \advance\pgf@x by \offset
            \advance\pgf@y by -\offset
            \pgfextract@process\lowernortheastcenter{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
            \addtosavedmacro{\lowernortheastcenter}
            % \uppersouthwestjoin
            % \pgf@yc=\pgf@y
            \pgf@process{\pgfpointintersectionofcircles{\uppersouthwestcenter}{\lowersouthwestcenter}{\scarceoffset}{\scarceoffset}{1}}
            \pgfextract@process\leftintersection{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
            \addtosavedmacro{\leftintersection}
            \pgf@process{\pgfpointintersectionofcircles{\uppernortheastcenter}{\lowernortheastcenter}{\scarceoffset}{\scarceoffset}{2}}
            \pgfextract@process\rightintersection{\pgfpoint{\the\pgf@x}{\the\pgf@y}}
            \addtosavedmacro{\rightintersection}
        \fi
    }

    \inheritanchorborder[from=rectangle]

    \foreach \a in {center, north, south, west, east, south east, south west, north east, north west}
    {
        \inheritanchor[from=rectangle]{\a}
    }

    \backgroundpath{
        \computecoordinates
        \pgfpathmoveto{\uppernorthwestjoin}
        \pgfpathlineto{\uppernortheastjoin}
        \pgfpatharc{90}{0}{\scarceoffset}
        \pgfpathlineto{\uppereastsouthjoin}
        \pgfpatharc{0}{-90}{\scarceoffset}
        \pgfpathlineto{\uppersouthwestjoin}
        \pgfpatharc{-90}{-180}{\scarceoffset}
        \pgfpathlineto{\upperwestnorthjoin}
        \pgfpatharc{-180}{-270}{\scarceoffset}
        \pgfpathclose

        \pgf@xa=\offset
        \pgf@xb=\scarceoffset
        \ifdim\pgf@xa>\pgf@xb
            \pgfpathmoveto{\leftintersection}
            \pgfpathlineto{\uppersoutheastjoin}
            \pgfpatharc{-90}{0}{\scarceoffset}
            \pgfpathlineto{\rightintersection}
            \pgfpathlineto{\lowernortheastjoin}
            \pgfpatharc{90}{0}{\scarceoffset}
            \pgfpathlineto{\lowereastsouthjoin}
            \pgfpatharc{0}{-90}{\scarceoffset}
            \pgfpathlineto{\lowersouthwestjoin}
            \pgfpatharc{-90}{-180}{\scarceoffset}
            \pgfpathclose
        \else
            \pgfpathmoveto{\uppersouthwestjoin}
            \pgfpathlineto{\uppersoutheastjoin}
            \pgfpatharc{-90}{0}{\scarceoffset}
            \pgfpathlineto{\uppereastnorthjoin}
            \rightintersection
            \pgf@ya=\pgf@y
            \pgf@process{\circlefindangle{\uppernortheastcenter}{\scarceoffset}{\pgf@ya}{2}}
            \pgfpatharc{0}{\pgf@x}{\scarceoffset}
            \circlefindangle{\lowernortheastcenter}{\scarceoffset}{\pgf@ya}{2}
            \pgfpatharc{\pgf@x}{0}{\scarceoffset}
            \pgfpathlineto{\lowereastsouthjoin}
            \pgfpatharc{0}{-90}{\scarceoffset}
            \pgfpathlineto{\lowersouthwestjoin}
            \leftintersection
            \pgf@ya=\pgf@y
            \pgf@process{\circlefindangle{\lowersouthwestcenter}{\scarceoffset}{\pgf@ya}{1}}
            \pgfpatharc{-90}{\pgf@x}{\scarceoffset}
            \pgf@process{\circlefindangle{\uppersouthwestcenter}{\scarceoffset}{\pgf@ya}{1}}
            \pgfpatharc{\pgf@x}{-90}{\scarceoffset}
            \pgfpathclose
        \fi
    }

    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffsetratio{0.25}
            \computecoordinates
            \upperwestnorthjoin
            \pgf@xc=\pgf@x
            \pgf@ya=\pgf@y
            \uppersouthwestjoin
            \advance\pgf@ya by -\pgf@y
            \newdimen\cloneoffset
            \cloneoffset=\cloneoffsetratio\pgf@ya
            \pgf@yc=\pgf@y
            \advance\pgf@yc by \cloneoffset
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \uppereastnorthjoin
            \pgf@xc=\pgf@x
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \lowersoutheastjoin
            \pgf@yc=\pgf@y
            \advance\pgf@yc by \cloneoffset
            \pgf@xb=\offset
            \advance\pgf@xb by \scarceoffset\relax
            \ifdim\cloneoffset>\pgf@xb
                \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \else
                \pgfpathlineto{\uppereastsouthjoin}
                \uppereastsouthjoin
                \advance\pgf@x by -\scarceoffset
                \pgf@process{\circlefindangle{\pgfpoint{\pgf@x}{\pgf@y}}{\scarceoffset}{\pgf@yc}{2}}
                \pgfpatharc{0}{\pgf@x}{\scarceoffset}
            \fi
            \lowereastsouthjoin
            \pgf@xc=\pgf@x
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfpathlineto{\lowereastsouthjoin}
            \pgfpatharc{0}{-90}{\scarceoffset}
            \pgfpathlineto{\lowersouthwestjoin}
            \pgf@xa=\offset
            \pgf@xb=\scarceoffset\relax
            \ifdim\pgf@xa>\pgf@xb
                \pgfpatharc{-90}{-180}{\scarceoffset}
                \pgfpathlineto{\leftintersection}
                \pgfpathlineto{\uppersouthwestjoin}
                \pgfpatharc{-90}{-180}{\scarceoffset}
            \else
                \leftintersection
                \pgf@yc=\pgf@y
                \pgf@process{\circlefindangle{\lowersouthwestcenter}{\scarceoffset}{\pgf@yc}{1}}
                \pgfpatharc{-90}{\pgf@x}{\scarceoffset}
                \pgf@process{\circlefindangle{\uppersouthwestcenter}{\scarceoffset}{\pgf@yc}{1}}
                \pgfpatharc{\pgf@x}{-180}{\scarceoffset}
            \fi
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{fill, stroke}
        \fi
    }
}
