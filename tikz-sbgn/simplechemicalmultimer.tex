\pgfdeclareshape{simplechemicalmultimer}{

    \savedmacro{\offsetratio}{\def\offsetratio{0.1}}

    \savedmacro\computecoordinates{%
        \pgf@y = \ht\pgfnodeparttextbox
        \advance\pgf@y by \dp\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner ysep}}
        \advance\pgf@y by 2\pgf@xa
        \pgfmathsetlength{\pgf@y}{\pgf@y/(1-\offsetratio)}
        \pgf@yb=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yb>\pgf@y
            \pgf@y=\pgf@yb
        \fi
        \pgf@yb=\offsetratio\pgf@y
        \pgfmathsetlengthmacro\offset{\pgf@yb}
        \addtosavedmacro\offset
        \pgf@x=\wd\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner xsep}}
        \advance\pgf@x by 2\pgf@xa
        \pgf@xb=\pgfkeysvalueof{/pgf/minimum width}
        \advance\pgf@x by \offset
        \ifdim\pgf@xb>\pgf@x
            \pgf@x=\pgf@xb
        \fi
        \ifdim\pgf@y>\pgf@x
            \pgf@x=\pgf@y
        \fi
        \@tempdima=\pgf@x
        \@tempdimb=\pgf@y
        \pgf@yc=\@tempdimb
        \advance\pgf@yc by -\offset
        \pgf@yc=0.5\pgf@yc
        \pgfmathsetlengthmacro{\radius}{\the\pgf@yc}
        \addtosavedmacro{\radius}
        \pgf@xa=-0.5\@tempdima
        \pgfmathaddtolength{\pgf@xa}{0.5*\offset}
        \advance\pgf@xa 0.5\wd\pgfnodeparttextbox
        \pgfmathaddtolength{\pgf@xa}{\radius}
        \pgf@ya=0.5\ht\pgfnodeparttextbox
        \advance\pgf@ya by -0.5\dp\pgfnodeparttextbox
        \pgfextract@process\upperleftcenter{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\upperleftcenter}
        \pgf@xc=\pgf@xa
        \pgf@yc=\pgf@ya
        \advance\pgf@yc by \radius
        \pgfextract@process\upperleftjoin{\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}
        \addtosavedmacro{\upperleftjoin}
        \pgf@yc=\pgf@ya
        \advance\pgf@yc by -\radius
        \pgfextract@process\middleleftjoin{\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}
        \addtosavedmacro{\middleleftjoin}
        \pgf@xc=\pgf@xa
        \advance\pgf@xc by \offset
        \pgf@yc=\pgf@ya
        \advance\pgf@yc by -\offset
        \pgfextract@process\lowerleftcenter{\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}
        \addtosavedmacro{\lowerleftcenter}
        \advance\pgf@yc by -\radius
        \pgfextract@process\lowerleftjoin{\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}
        \addtosavedmacro{\lowerleftjoin}
        \pgf@xc=\pgf@xa
        \advance\pgf@xc by \@tempdima
        \pgfmathaddtolength{\pgf@xc}{-2*\radius}
        \advance\pgf@xc by -\offset
        \pgf@yc=\pgf@ya
        \pgfextract@process\upperrightcenter{\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}
        \addtosavedmacro{\upperrightcenter}
        \advance\pgf@yc by \radius
        \pgfextract@process\upperrightjoin{\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}
        \addtosavedmacro{\upperrightjoin}
        \pgf@yc=\pgf@ya
        \advance\pgf@yc by -\radius
        \pgfextract@process\middlerightjoin{\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}
        \addtosavedmacro{\middlerightjoin}
        \advance\pgf@xc by \offset
        \pgf@yc=\pgf@ya
        \advance\pgf@yc by -\offset
        \pgfextract@process\lowerrightcenter{\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}
        \addtosavedmacro{\lowerrightcenter}
        \advance\pgf@yc by -\radius
        \pgfextract@process\lowerrightjoin{\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}
        \addtosavedmacro{\lowerrightjoin}
        \pgf@process{\pgfpointintersectionofcircles{\upperleftcenter}{\lowerleftcenter}{\radius}{\radius}{1}}
        \pgfextract@process\leftintersection{\noexpand\pgfpoint{\the\pgf@x}{\the\pgf@y}}
        \addtosavedmacro{\leftintersection}
        \pgf@process{\pgfpointintersectionofcircles{\upperrightcenter}{\lowerrightcenter}{\radius}{\radius}{2}}
        \pgfextract@process\rightintersection{\noexpand\pgfpoint{\the\pgf@x}{\the\pgf@y}}
        \addtosavedmacro{\rightintersection}
    }
    %

    \anchor{center}{
        \computecoordinates
        \pgf@process{\lowerrightcenter}
        \pgf@xa=\pgf@x
        \pgf@process{\upperleftcenter}
        \pgf@x=0.5\pgf@x
        \advance\pgf@x by 0.5\pgf@xa
        \pgfmathaddtolength{\pgf@y}{-0.5*\offset}
    }

    \anchor{north}{
        \computecoordinates
        \lowerrightcenter
        \pgf@xa=\pgf@x
        \upperleftcenter
        \pgf@x=-0.5\pgf@x
        \pgf@x=0.5\pgf@xa
        \pgfmathaddtolength{\pgf@x}{0.5*\pgf@xa}
        \pgfmathaddtolength{\pgf@x}{0.5*\offset}
        \advance\pgf@y by \radius
    }

    \foreach \a in {west, east, north east, south west, north west, south east}
    {
        \inheritanchor[from=rectangle]{\a}
    }

    \anchorborder{
        \@tempdima=\pgf@x
        \@tempdimb=\pgf@y
        \pgf@sh@reanchor{simplechemicalmultimer}{center}
        \advance\@tempdima by \pgf@x
        \advance\@tempdimb by \pgf@y
        \computecoordinates
        \edef\pgf@marshal{
            \noexpand\belongstocone
            {\noexpand\pgf@sh@reanchor{simplechemicalmultimer}{center}}
            {\noexpand\upperleftjoin}%
            {\noexpand\upperrightjoin}%
            {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
        }
        \pgf@process{\pgf@marshal}
        \if@tempswa
            \edef\pgf@marshal{
                \noexpand\pointborderrectanglecorners
                {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}
                {\noexpand\pgfpointadd{\middleleftjoin}{\noexpand\pgfpoint{0}{-\offset}}}
                {\noexpand\pgfpointadd{\upperrightjoin}{\noexpand\pgfpoint{\offset}{0}}}
            }
            \pgf@process{\pgf@marshal}
        \else
            \edef\pgf@marshal{
                \noexpand\belongstocone
                {\noexpand\pgf@sh@reanchor{simplechemicalmultimer}{center}}
                {\upperrightjoin}
                {\rightintersection}
                {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}
            }
            \pgf@process{\pgf@marshal}
            \if@tempswa
                \pgf@sh@reanchor{simplechemicalmultimer}{center}
                \ifdim\@tempdima<\pgf@x
                    \c@pgf@counta=1
                \else
                    \c@pgf@counta=2
                \fi
                \edef\pgf@marshal{
                    \noexpand\intersectionlinecircle
                    {\noexpand\pgf@sh@reanchor{simplechemicalmultimer}{center}}
                    {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}
                    {\upperrightcenter}
                    {\radius}
                    {\the\c@pgf@counta}
                }
                \pgf@process{\pgf@marshal}
            \else
                \edef\pgf@marshal{
                    \noexpand\belongstocone
                    {\noexpand\pgf@sh@reanchor{simplechemicalmultimer}{center}}
                    {\rightintersection}
                    {\lowerrightjoin}
                    {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}
                }
                \pgf@process{\pgf@marshal}
                \if@tempswa
                    \edef\pgf@marshal{
                        \noexpand\intersectionlinecircle
                        {\noexpand\pgf@sh@reanchor{simplechemicalmultimer}{center}}
                        {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}
                        {\lowerrightcenter}
                        {\radius}
                        {2}
                    }
                    \pgf@process{\pgf@marshal}
                \else
                    \edef\pgf@marshal{
                        \noexpand\belongstocone
                        {\noexpand\pgf@sh@reanchor{simplechemicalmultimer}{center}}
                        {\lowerrightjoin}
                        {\lowerleftjoin}
                        {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}
                    }
                    \pgf@process{\pgf@marshal}
                    \if@tempswa
                        \edef\pgf@marshal{
                            \noexpand\pointborderrectanglecorners
                            {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}
                            {\noexpand\pgfpointadd{\middleleftjoin}{\noexpand\pgfpoint{0}{-\offset}}}
                            {\noexpand\pgfpointadd{\upperrightjoin}{\noexpand\pgfpoint{\offset}{0}}}
                        }
                        \pgf@process{\pgf@marshal}
                    \else
                        \edef\pgf@marshal{
                            \noexpand\belongstocone
                            {\noexpand\pgf@sh@reanchor{simplechemicalmultimer}{center}}
                            {\lowerleftjoin}
                            {\leftintersection}
                            {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}
                        }
                        \pgf@process{\pgf@marshal}
                        \if@tempswa
                            \pgf@sh@reanchor{simplechemicalmultimer}{center}
                            \ifdim\@tempdima>\pgf@x
                                \c@pgf@counta=2
                            \else
                                \c@pgf@counta=1
                            \fi
                            \edef\pgf@marshal{
                                \noexpand\intersectionlinecircle
                                {\noexpand\pgf@sh@reanchor{simplechemicalmultimer}{center}}
                                {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}
                                {\lowerleftcenter}
                                {\radius}
                                {\the\c@pgf@counta}
                            }
                            \pgf@process{\pgf@marshal}
                        \else
                            \edef\pgf@marshal{
                                \noexpand\intersectionlinecircle
                                {\noexpand\pgf@sh@reanchor{simplechemicalmultimer}{center}}
                                {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}
                                {\upperleftcenter}
                                {\radius}
                                {1}
                            }
                            \pgf@process{\pgf@marshal}
                        \fi
                    \fi
                \fi
            \fi
        \fi
    }

    \backgroundpath{
        \computecoordinates
        \pgfpathmoveto{\upperleftjoin}
        \pgfpathlineto{\upperrightjoin}
        \pgfpatharc{90}{-90}{\radius}
        \pgfpathlineto{\middleleftjoin}
        \pgfpatharc{90}{-90}{-\radius}
        \pgfpathclose

        \leftintersection
        \pgf@xc=\pgf@x
        \pgf@yc=\pgf@y
        \pgfpathmoveto{\pgfpoint{\pgf@x}{\pgf@y}}
        \pgf@process{\circlefindangle{\lowerleftcenter}{\radius}{\pgf@yc}{1}}
        \pgfpatharc{\pgf@x}{-90}{\radius}
        \pgfpathlineto{\lowerrightjoin}
        \rightintersection
        \pgf@yc=\pgf@y
        \pgf@process{\circlefindangle{\lowerrightcenter}{\radius}{\pgf@yc}{2}}
        \pgfpatharc{-90}{\pgf@x}{\radius}
        \pgf@process{\circlefindangle{\upperrightcenter}{\radius}{\pgf@yc}{2}}
        \pgfpatharc{\pgf@x}{-90}{\radius}
        \pgflineto{\middleleftjoin}
        \leftintersection
        \pgf@yc=\pgf@y
        \pgf@process{\circlefindangle{\upperleftcenter}{\radius}{\pgf@yc}{1}}
        \pgfpatharc{-90}{\pgf@x}{\radius}
        \pgfpathclose
    }

    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffsetratio{0.25}
            \computecoordinates
            \newdimen\cloneoffset
            \pgfmathsetlength{\cloneoffset}{\cloneoffsetratio*2*\radius}
            \middleleftjoin
            \pgf@yc=\pgf@y
            \advance\pgf@yc by \cloneoffset
            \pgf@yb=\pgf@yc
            \pgf@process{\circlefindx{\upperleftcenter}{\radius}{\pgf@yc}{1}}
            \pgfpathmoveto{\pgfpoint{\pgf@x}{\pgf@yc}}
            \pgf@process{\circlefindx{\upperrightcenter}{\radius}{\pgf@yc}{2}}
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@yc}}
            \pgf@process{\circlefindangle{\upperrightcenter}{\radius}{\pgf@yc}{2}}
            \pgf@xc=\pgf@x
            \lowerrightjoin
            \pgf@yc=\pgf@y
            \advance\pgf@yc by \cloneoffset
            \pgf@process{\circlefindangle{\upperrightcenter}{\radius}{\pgf@yc}{2}}
            \pgfpatharc{\pgf@xc}{\pgf@x}{\radius}
            \pgf@process{\circlefindx{\lowerrightcenter}{\radius}{\pgf@yc}{2}}
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@yc}}
            \pgf@process{\circlefindangle{\lowerrightcenter}{\radius}{\pgf@yc}{2}}
            \pgfpatharc{\pgf@x}{-90}{\radius}
            \pgfpathlineto{\lowerleftjoin}
            \leftintersection
            \pgf@yc=\pgf@y
            \pgf@process{\circlefindangle{\lowerleftcenter}{\radius}{\pgf@yc}{1}}
            \pgfpatharc{-90}{\pgf@x}{\radius}
            \pgf@process{\circlefindangle{\upperleftcenter}{\radius}{\pgf@yc}{1}}
            \pgf@xc=\pgf@x
            \pgf@process{\circlefindangle{\upperleftcenter}{\radius}{\pgf@yb}{1}}
            \pgfpatharc{\pgf@xc}{\pgf@x}{\radius}
            % \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{stroke, fill}
        \fi
    }
}
