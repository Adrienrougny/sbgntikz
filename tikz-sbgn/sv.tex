%Copyright 2018 by Adrien Rougny
%This file may be distributed and/or modified under the terms of the GNU General Public License version 3
%See the file LICENSE.txt
\pgfdeclareshape{sv}{

    \savedanchor\northeast{
        \pgf@x = \wd\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner xsep}}
        \advance\pgf@x by 2\pgf@xa
        \pgf@xb=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xb>\pgf@x
            \pgf@x=\pgf@xb
        \fi
        \pgf@y = \ht\pgfnodeparttextbox
        \advance\pgf@y by \dp\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner ysep}}
        \advance\pgf@y by 2\pgf@xa
        \pgf@yb=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yb>\pgf@y
            \pgf@y=\pgf@yb
        \fi
        \ifdim\pgf@y>\pgf@x
            \pgf@x=\pgf@y
        \fi
        \pgf@x = 0.5\pgf@x
        \advance\pgf@x by 0.5\wd\pgfnodeparttextbox
        \pgf@y = 0.5\pgf@y
        \advance\pgf@y by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@y by -0.5\dp\pgfnodeparttextbox
    }

    \savedanchor\southwest{
        \pgf@x = \wd\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner xsep}}
        \advance\pgf@x by 2\pgf@xa
        \pgf@xb=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xb>\pgf@x
            \pgf@x=\pgf@xb
        \fi
        \pgf@y = \ht\pgfnodeparttextbox
        \advance\pgf@y by \dp\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner ysep}}
        \advance\pgf@y by 2\pgf@xa
        \pgf@yb=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yb>\pgf@y
            \pgf@y=\pgf@yb
        \fi
        \ifdim\pgf@y>\pgf@x
            \pgf@x=\pgf@y
        \fi
        \pgf@x = -0.5\pgf@x
        \advance\pgf@x by 0.5\wd\pgfnodeparttextbox
        \pgf@y = -0.5\pgf@y
        \advance\pgf@y by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@y by -0.5\dp\pgfnodeparttextbox
    }

    \foreach \a in {center, north, south, west, east, south east, south west, north east, north west}
    {
        \inheritanchor[from=rectangle]{\a}
    }

    \anchorborder{
        \@tempdima = \pgf@x
        \@tempdimb = \pgf@y
        \pgf@process{\southwest}
        \pgf@xa=\pgf@x
        \pgf@ya=\pgf@y
        % \pgfmathsetlength{\pgf@xc}{\pgfkeysvalueof{/pgf/outer xsep}}
        % \pgfmathsetlength{\pgf@yc}{\pgfkeysvalueof{/pgf/outer ysep}}
        % \advance\pgf@xa by \pgf@xc
        % \advance\pgf@ya by \pgf@yc
        \pgf@process{\northeast}
        \pgf@xb=\pgf@x
        \pgf@yb=\pgf@y
        % \advance\pgf@xb by-1\pgf@xc
        % \advance\pgf@yb by-1\pgf@yc
        \newdimen\radius
        \radius = 0.5\pgf@yb
        \advance\radius by -0.5\pgf@ya
        \advance\pgf@xa by \radius
        \advance\pgf@xb by -\radius
        \pgf@xc = 0.5\pgf@xa
        \advance\pgf@xc by 0.5\pgf@xb
        \pgf@yc = 0.5\pgf@ya
        \advance\pgf@yc by 0.5\pgf@yb
        \edef\pgf@marshal{%
            \noexpand\belongstocone
            {\noexpand\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}%
            {\noexpand\pgfpoint{\the\pgf@xa}{\the\pgf@yb}}%
            {\noexpand\pgfpoint{\the\pgf@xb}{\the\pgf@yb}}%
            {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
        }
        \pgf@process{\pgf@marshal}
        \if@tempswa
            \pgf@process{\pointborderrectanglecorners{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgfpoint{\pgf@xa}{\pgf@ya}}{\pgfpoint{\pgf@xb}{\pgf@yb}}}
        \else
            \edef\pgf@marshal{%
                \noexpand\belongstocone
                {\noexpand\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}%
                {\noexpand\pgfpoint{\the\pgf@xb}{\the\pgf@ya}}%
                {\noexpand\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}%
                {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
            }
            \pgf@process{\pgf@marshal}
            \if@tempswa
                \pgf@process{\pointborderrectanglecorners{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgfpoint{\pgf@xa}{\pgf@ya}}{\pgfpoint{\pgf@xb}{\pgf@yb}}}
            \else
                \edef\pgf@marshal{%
                    \noexpand\belongstocone
                    {\noexpand\pgfpoint{\the\pgf@xc}{\the\pgf@yc}}%
                    {\noexpand\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}%
                    {\noexpand\pgfpoint{\the\pgf@xa}{\the\pgf@yb}}%
                    {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
                }
                \pgf@process{\pgf@marshal}
                \if@tempswa
                    \pgf@process{\pointbordercircle{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgfpoint{\pgf@xa}{\pgf@yc}}{\radius}}
                \else
                    \pgf@process{\pointbordercircle{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgfpoint{\pgf@xb}{\pgf@yc}}{\radius}}
                \fi
            \fi
        \fi
    }

    \backgroundpath{
        \pgf@process{\southwest}
        \pgf@xa=\pgf@x
        \pgf@ya=\pgf@y
        % \pgfmathsetlength{\pgf@xc}{\pgfkeysvalueof{/pgf/outer xsep}}
        % \pgfmathsetlength{\pgf@yc}{\pgfkeysvalueof{/pgf/outer ysep}}
        % \advance\pgf@xa by \pgf@xc
        % \advance\pgf@ya by \pgf@yc
        \pgf@process{\northeast}
        \pgf@xb=\pgf@x
        \pgf@yb=\pgf@y
        % % \advance\pgf@xb by-1\pgf@xc
        % % \advance\pgf@yb by-1\pgf@yc
        \newdimen\radius
        \radius = 0.5\pgf@yb
        \advance\radius by -0.5\pgf@ya
        % \advance\radius by -0.5\pgflinewidth
        \advance\pgf@xa by \radius
        \advance\pgf@xb by -\radius
        \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
        \pgfpatharc{90}{-90}{\radius}
        \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@ya}}
        \pgfpatharc{270}{90}{\radius}
        \pgfpathclose
    }
}
