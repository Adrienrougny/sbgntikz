%Copyright 2018 by Adrien Rougny
%This file may be distributed and/or modified under the terms of the GNU General Public License version 3
%See the file LICENSE.txt
\pgfdeclareshape{macromolecule}{

    \savedmacro{\scarceratio}{\def\scarceratio{0.1}}

    \savedmacro\computecoordinates{%
        \pgf@yb = \ht\pgfnodeparttextbox
        \advance\pgf@yb by \dp\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner ysep}}
        \advance\pgf@yb by 2\pgf@xa
        \pgf@yc=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yc>\pgf@yb
            \pgf@yb=\pgf@yc
        \fi
        \pgf@xb=\wd\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner xsep}}
        \advance\pgf@xb by 2\pgf@xa
        \pgf@xc=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xc>\pgf@xb
            \pgf@xb=\pgf@xc
        \fi
        \ifdim\pgf@yb>\pgf@xb
            \pgfmathsetlengthmacro\scarceoffset{\scarceratio*\pgf@xb}
        \else
            \pgfmathsetlengthmacro\scarceoffset{\scarceratio*\pgf@yb}
        \fi
        \addtosavedmacro\scarceoffset
        \pgf@xa=-0.5\pgf@xb
        \advance\pgf@xa by 0.5\wd\pgfnodeparttextbox
        \pgf@xc=\pgf@xa %saving for later
        \pgf@ya=0.5\pgf@yb
        \advance\pgf@ya by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@ya by -0.5\dp\pgfnodeparttextbox
        \advance\pgf@ya by -\scarceoffset
        \pgfextract@process\westnorthjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\westnorthjoin}
        \advance\pgf@ya by \scarceoffset
        \advance\pgf@xa by \scarceoffset
        \pgfextract@process\northwestjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\northwestjoin}
        \advance\pgf@xa by \pgf@xb
        \pgfmathaddtolength{\pgf@xa}{-2*\scarceoffset}
        \pgfextract@process\northeastjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\northeastjoin}
        \advance\pgf@ya by -\scarceoffset
        \advance\pgf@xa by \scarceoffset
        \pgfextract@process\eastnorthjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\eastnorthjoin}
        \advance\pgf@ya by -\pgf@yb
        \pgfmathaddtolength{\pgf@ya}{2*\scarceoffset}
        \pgfextract@process\eastsouthjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\eastsouthjoin}
        \advance\pgf@ya by -\scarceoffset
        \advance\pgf@xa by -\scarceoffset
        \pgfextract@process\southeastjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\southeastjoin}
        \pgf@xa=\pgf@xc
        \advance\pgf@xa by \scarceoffset
        \pgfextract@process\southwestjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\southwestjoin}
        \advance\pgf@xa by -\scarceoffset
        \advance\pgf@ya by \scarceoffset
        \pgfextract@process\westsouthjoin{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro{\westsouthjoin}
    }

    \savedanchor{\southwest}{
        \westnorthjoin
        \pgf@xc=\pgf@x
        \southwestjoin
        \pgf@x=\pgf@xc
    }

    \savedanchor{\northeast}{
        \eastnorthjoin
        \pgf@xc=\pgf@x
        \northeastjoin
        \pgf@x=\pgf@xc
    }

    \anchor{south west}{
        \southwest
    }

    \anchor{north east}{
        \northeast
    }


    \anchor{south east}{
        \northeast
        \pgf@xc=\pgf@x
        \southwest
        \pgf@x=\pgf@xc
    }

    \anchor{north west}{
        \southwest
        \pgf@xc=\pgf@x
        \northeast
        \pgf@x=\pgf@xc
    }

    \inheritanchorborder[from=rectangle]

    \foreach \a in {center, north, south, west, east}
    {
        \inheritanchor[from=rectangle]{\a}
    }

    \backgroundpath{
        \pgfpathmoveto{\northwestjoin}
        \pgfpathlineto{\northeastjoin}
        \pgfpatharc{90}{0}{\scarceoffset}
        \pgfpathlineto{\eastsouthjoin}
        \pgfpatharc{0}{-90}{\scarceoffset}
        \pgfpathlineto{\southwestjoin}
        \pgfpatharc{-90}{-180}{\scarceoffset}
        \pgfpathlineto{\westnorthjoin}
        \pgfpatharc{-180}{-270}{\scarceoffset}
        \pgfpathclose
    }

    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffsetratio{0.25}
            \computecoordinates
            \northwestjoin
            \pgf@ya=\pgf@y
            \southwestjoin
            \advance\pgf@ya by -\pgf@y
            \newdimen\cloneoffset
            \cloneoffset=\cloneoffsetratio\pgf@ya
            \pgf@yc=\pgf@y
            \advance\pgf@yc by \cloneoffset
            \westsouthjoin
            \pgf@xc=\pgf@x
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \eastnorthjoin
            \pgf@xc=\pgf@x
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfpathlineto{\eastsouthjoin}
            \pgfpatharc{0}{-90}{\scarceoffset}
            \pgfpathlineto{\southwestjoin}
            \pgfpatharc{-90}{-180}{\scarceoffset}
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{fill, stroke}
        \fi
    }
}
