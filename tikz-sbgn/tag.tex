\pgfdeclareshape{tag}{

    \inheritsavedanchors[from=rectangle] % this is nearly a rectangle

    \savedmacro{\pointratio}{\def\pointratio{0.25}}

    \savedmacro\computecoordinates{%
        \pgfkeysgetvalue{/pgf/orientation}{\orientation}
        \pgf@yb = \ht\pgfnodeparttextbox
        \advance\pgf@yb by \dp\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner ysep}}
        \advance\pgf@yb by 2\pgf@xa
        \ifx\orientation\oup
            \pgfmathsetlength{\pgf@yb}{\pgf@yb/(1-\pointratio)}
        \fi
        \ifx\orientation\odown
            \pgfmathsetlength{\pgf@yb}{\pgf@yb/(1-\pointratio)}
        \fi
        \pgf@yc=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yc>\pgf@yb
            \pgf@yb=\pgf@yc
        \fi
        \ifx\orientation\oup
            \pgfmathsetlengthmacro\pointoffset{\pointratio*\pgf@yb}
        \fi
        \ifx\orientation\odown
            \pgfmathsetlengthmacro\pointoffset{\pointratio*\pgf@yb}
        \fi
        \pgf@xb = \wd\pgfnodeparttextbox
        \pgfmathsetlength{\pgf@xa}{\pgfkeysvalueof{/pgf/inner xsep}}
        \advance\pgf@xb by 2\pgf@xa
        \ifx\orientation\oleft
            \pgfmathsetlength{\pgf@xb}{\pgf@xb/(1-\pointratio)}
        \fi
        \ifx\orientation\oright
            \pgfmathsetlength{\pgf@xb}{\pgf@xb/(1-\pointratio)}
        \fi
        \pgf@xc=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xc>\pgf@xb
            \pgf@xb=\pgf@xc
        \fi
        \ifx\orientation\oleft
            \pgfmathsetlengthmacro\pointoffset{\pointratio*\pgf@xb}
        \fi
        \ifx\orientation\oright
            \pgfmathsetlengthmacro\pointoffset{\pointratio*\pgf@xb}
        \fi
        \addtosavedmacro\pointoffset
        \pgf@xa=-0.5\pgf@xb
        \ifx\orientation\oright
            \pgfmathaddtolength{\pgf@xa}{0.5*\pointoffset}
        \fi
        \ifx\orientation\oleft
            \pgfmathaddtolength{\pgf@xa}{0.5*\pointoffset}
        \fi
        \advance\pgf@xa by 0.5\wd\pgfnodeparttextbox
        \pgf@ya=-0.5\pgf@yb
        \advance\pgf@ya by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@ya by -0.5\dp\pgfnodeparttextbox
        \ifx\orientation\oup
            \pgfmathaddtolength{\pgf@ya}{0.5*\pointoffset}
        \fi
        \ifx\orientation\odown
            \pgfmathaddtolength{\pgf@ya}{0.5*\pointoffset}
        \fi
        \pgfextract@process\southwest{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro\southwest
        \advance\pgf@xa by \pgf@xb
        \ifx\orientation\oright
            \advance\pgf@xa by -\pointoffset
        \fi
        \ifx\orientation\oleft
            \advance\pgf@xa by -\pointoffset
        \fi
        \advance\pgf@ya by \pgf@yb
        \ifx\orientation\oup
            \advance\pgf@ya by -\pointoffset
        \fi
        \ifx\orientation\odown
            \advance\pgf@ya by -\pointoffset
        \fi
        \pgfextract@process\northeast{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro\northeast
        \ifx\orientation\oright
            \advance\pgf@ya by -0.5\pgf@yb
            \advance\pgf@xa by \pointoffset
        \fi
        \ifx\orientation\oleft
            \advance\pgf@ya by -0.5\pgf@yb
            \advance\pgf@xa by -\pgf@xb
        \fi
        \ifx\orientation\odown
            \advance\pgf@ya by -\pgf@yb
            \advance\pgf@xa by -0.5\pgf@xb
        \fi
        \ifx\orientation\oup
            \advance\pgf@ya by \pointoffset
            \advance\pgf@xa by -0.5\pgf@xb
        \fi
        \pgfextract@process\pointangle{\pgfpoint{\the\pgf@xa}{\the\pgf@ya}}
        \addtosavedmacro\pointangle
    }

    \anchor{south west}{
        \computecoordinates
        \southwest
    }

    \anchor{north east}{
        \computecoordinates
        \northeast
    }

    \anchor{south east}{
        \computecoordinates
        \northeast
        \pgf@xa=\pgf@x
        \southwest
        \pgf@x=\pgf@xa
    }

    \anchor{north west}{
        \computecoordinates
        \northeast
        \pgf@ya=\pgf@y
        \southwest
        \pgf@y=\pgf@ya
    }

    \anchor{north}{
        \computecoordinates
        \pointangle
        \pgf@ya=\pgf@y
        \northeast
        \ifdim\pgf@ya>\pgf@y
            \pointangle
        \else
            \pgf@ya=\pgf@y
            \pgf@xa=0.5\pgf@x
            \southwest
            \advance\pgf@xa by 0.5\pgf@x
            \pgf@x=\pgf@xa
            \pgf@y=\pgf@ya
        \fi
    }

    \anchor{south}{
        \computecoordinates
        \pointangle
        \pgf@ya=\pgf@y
        \southwest
        \ifdim\pgf@ya<\pgf@y
            \pointangle
        \else
            \pgf@ya=\pgf@y
            \pgf@xa=0.5\pgf@x
            \northeast
            \advance\pgf@xa by 0.5\pgf@x
            \pgf@x=\pgf@xa
            \pgf@y=\pgf@ya
        \fi
    }

    \anchor{east}{
        \computecoordinates
        \pointangle
        \pgf@xa=\pgf@x
        \northeast
        \ifdim\pgf@xa>\pgf@x
            \pointangle
        \else
            \pgf@xa=\pgf@x
            \pgf@ya=0.5\pgf@y
            \southwest
            \advance\pgf@ya by 0.5\pgf@y
            \pgf@x=\pgf@xa
            \pgf@y=\pgf@ya
        \fi
    }

    \anchor{west}{
        \computecoordinates
        \pointangle
        \pgf@xa=\pgf@x
        \southwest
        \ifdim\pgf@xa<\pgf@x
            \pointangle
        \else
            \pgf@xa=\pgf@x
            \pgf@ya=0.5\pgf@y
            \northeast
            \advance\pgf@ya by 0.5\pgf@y
            \pgf@x=\pgf@xa
            \pgf@y=\pgf@ya
        \fi
    }

    \anchor{center}{
        \computecoordinates
        \pgf@process{\southwest}
        \pgf@xa=0.5\pgf@x
        \pgf@ya=0.5\pgf@y
        \pgf@process{\northeast}
        \advance\pgf@xa by 0.5\pgf@x
        \advance\pgf@ya by 0.5\pgf@y
        \pgf@x=\pgf@xa
        \pgf@y=\pgf@ya
    }

    \anchorborder{
        \@tempdima=\pgf@x
        \@tempdimb=\pgf@y
        \pgf@sh@reanchor{tag}{center}
        \advance\@tempdima by \pgf@x
        \advance\@tempdimb by \pgf@y
        \computecoordinates
        \pointangle
        \pgf@xa=\pgf@x
        \pgf@ya=\pgf@y
        \northeast
        \ifdim\pgf@xa>\pgf@x
            \def\orientation{right}
        \fi
        \ifdim\pgf@ya>\pgf@y
            \def\orientation{up}
        \fi
        \southwest
        \ifdim\pgf@xa<\pgf@x
            \def\orientation{left}
        \fi
        \ifdim\pgf@ya<\pgf@y
            \def\orientation{down}
        \fi
        \ifx\orientation\oright
            \edef\pgf@marshal{%
                \noexpand\belongstocone
                {\noexpand\pgf@sh@reanchor{tag}{center}}
                {\noexpand\northeast}%
                {\noexpand\pointangle}%
                {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
            }
            \pgf@process{\pgf@marshal}
            \if@tempswa
                \pgfpointintersectionoflines{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgf@sh@reanchor{tag}{center}}{\northeast}{\pointangle}
            \else
                \edef\pgf@marshal{%
                    \noexpand\belongstocone
                    {\noexpand\pgf@sh@reanchor{tag}{center}}
                    {\noexpand\pointangle}%
                    {\noexpand\pgf@sh@reanchor{tag}{south east}}
                    {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
                }
                \pgf@process{\pgf@marshal}
                \if@tempswa
                    \pgfpointintersectionoflines{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgf@sh@reanchor{tag}{center}}{\pointangle}{\pgf@sh@reanchor{tag}{south east}}
                \else
                    \pointborderrectanglecorners{\pgfpoint{\@tempdima}{\@tempdimb}}{\southwest}{\northeast}
                \fi
            \fi
        \fi
        \ifx\orientation\oleft
            \edef\pgf@marshal{%
                \noexpand\belongstocone
                {\noexpand\pgf@sh@reanchor{tag}{center}}
                {\noexpand\southwest}%
                {\noexpand\pointangle}%
                {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
            }
            \pgf@process{\pgf@marshal}
            \if@tempswa
                \pgfpointintersectionoflines{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgf@sh@reanchor{tag}{center}}{\southwest}{\pointangle}
            \else
                \edef\pgf@marshal{%
                    \noexpand\belongstocone
                    {\noexpand\pgf@sh@reanchor{tag}{center}}
                    {\noexpand\pointangle}%
                    {\noexpand\pgf@sh@reanchor{tag}{north west}}
                    {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
                }
                \pgf@process{\pgf@marshal}
                \if@tempswa
                    \pgfpointintersectionoflines{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgf@sh@reanchor{tag}{center}}{\pointangle}{\pgf@sh@reanchor{tag}{north west}}
                \else
                    \pointborderrectanglecorners{\pgfpoint{\@tempdima}{\@tempdimb}}{\southwest}{\northeast}
                \fi
            \fi
        \fi
        \ifx\orientation\odown
            \edef\pgf@marshal{%
                \noexpand\belongstocone
                {\noexpand\pgf@sh@reanchor{tag}{center}}
                {\noexpand\pointangle}%
                {\noexpand\southwest}%
                {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
            }
            \pgf@process{\pgf@marshal}
            \if@tempswa
                \pgfpointintersectionoflines{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgf@sh@reanchor{tag}{center}}{\southwest}{\pointangle}
            \else
                \edef\pgf@marshal{%
                    \noexpand\belongstocone
                    {\noexpand\pgf@sh@reanchor{tag}{center}}
                    {\noexpand\pgf@sh@reanchor{tag}{south east}}
                    {\noexpand\pointangle}%
                    {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
                }
                \pgf@process{\pgf@marshal}
                \if@tempswa
                    \pgfpointintersectionoflines{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgf@sh@reanchor{tag}{center}}{\pointangle}{\pgf@sh@reanchor{tag}{south east}}
                \else
                    \pointborderrectanglecorners{\pgfpoint{\@tempdima}{\@tempdimb}}{\southwest}{\northeast}
                \fi
            \fi
        \fi
        \ifx\orientation\oup
            \edef\pgf@marshal{%
                \noexpand\belongstocone
                {\noexpand\pgf@sh@reanchor{tag}{center}}
                {\noexpand\pointangle}%
                {\noexpand\northeast}%
                {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
            }
            \pgf@process{\pgf@marshal}
            \if@tempswa
                \pgfpointintersectionoflines{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgf@sh@reanchor{tag}{center}}{\northeast}{\pointangle}
            \else
                \edef\pgf@marshal{%
                    \noexpand\belongstocone
                    {\noexpand\pgf@sh@reanchor{tag}{center}}
                    {\noexpand\pgf@sh@reanchor{tag}{north west}}
                    {\noexpand\pointangle}%
                    {\noexpand\pgfpoint{\the\@tempdima}{\the\@tempdimb}}%
                }
                \pgf@process{\pgf@marshal}
                \if@tempswa
                    \pgfpointintersectionoflines{\pgfpoint{\@tempdima}{\@tempdimb}}{\pgf@sh@reanchor{tag}{center}}{\pointangle}{\pgf@sh@reanchor{tag}{north west}}
                \else
                    \pointborderrectanglecorners{\pgfpoint{\@tempdima}{\@tempdimb}}{\southwest}{\northeast}
                \fi
            \fi
        \fi
    }

    \backgroundpath{
        \computecoordinates
        \pgf@process{\southwest}
        \pgf@xa=\pgf@x
        \pgf@ya=\pgf@y
        \pgf@process{\northeast}
        \pgf@xb=\pgf@x
        \pgf@yb=\pgf@y
        \pgfkeysgetvalue{/pgf/orientation}{\orientation}
        \ifx\orientation\oright
            \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
            \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@yb}}
            \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
            \pgfpathlineto{\pointangle}
            \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@ya}}
        \fi
        \ifx\orientation\oleft
            \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
            \pgfpathlineto{\pointangle}
            \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@yb}}
            \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
            \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@ya}}
        \fi
        \ifx\orientation\odown
            \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
            \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@yb}}
            \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
            \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@ya}}
            \pgfpathlineto{\pointangle}
        \fi
        \ifx\orientation\oup
            \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
            \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@yb}}
            \pgfpathlineto{\pointangle}
            \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
            \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@ya}}
        \fi
        \pgfclosepath
    }
}
