\usetikzlibrary{arrows.meta,shapes,positioning,fit}
% \usetikzlibrary{calc}

\newcommand{\circlefindx}[5]{
    \pgf@xa=#1
    \pgf@ya=#2
    \pgf@xb=#3
    \pgf@y=#4
    \advance\pgf@y by -\pgf@ya
    \pgfmathsetlength{\pgf@x}{sqrt(\pgf@xb^2-\pgf@y^2)}
    \ifnum #5=1
        \pgf@x=-\pgf@x
    \fi
    \advance\pgf@x by \pgf@xa
}

\newcommand\circlefindangle[5]{
    \pgf@xa=#1
    \pgf@ya=#2
    \pgf@xb=#3
    \pgf@y=#4
    \advance\pgf@y by -\pgf@ya
    \pgfmathsetlength{\pgf@x}{sqrt(\pgf@xb^2-\pgf@y^2)}
    \ifnum #5=1
        \pgf@x=-\pgf@x
    \fi
    % \pgfmathsetlength{\pgf@x}{atan2(\pgf@y,\pgf@x)}
    \pgfmathsetlength{\pgf@x}{round(atan2(\pgf@y,\pgf@x))}
}

\def\belongstocone#1#2#3#4{
    \pgf@process{#1}
    \pgf@xc=\pgf@x
    \pgf@yc=\pgf@y
    \pgf@process{#2}
    \pgf@xa=\pgf@x
    \pgf@ya=\pgf@y
    \pgf@process{#3}
    \pgf@xb=\pgf@x
    \pgf@yb=\pgf@y
    \pgf@process{#4}
    \ifdim\pgf@xa=\pgf@xc
        \ifdim\pgf@xb=\pgf@xc
            \ifdim\pgf@x=\pgf@xc
                \ifdim\pgf@y>=\pgf@yc
                    \true
                \else
                    \false
            \else
                \false
        \else
            \ifdim\pgf@xa<\pgf@xb
}

\def\true{true}
\def\vertical{vertical}
\def\horizontal{horizontal}

\pgfkeys{/pgf/.cd, clone/.initial=false, clone/.default=true}
\pgfkeys{/pgf/.cd, connectors/.initial=none}

\pgfdeclareshape{genericprocess}{
    % \savedmacro\lanchor{0.75}
    \inheritsavedanchors[from=rectangle]
    \inheritanchorborder[from=rectangle]
    \foreach \a in {center, south east, south west, north east, north west}
    {
        \inheritanchor[from=rectangle]{\a}
    }
    \savedanchor\connectoreast{
        \def\lconnectors{0.75}
        \pgfkeysgetvalue{/pgf/connectors}{\connectors}
        %compute width and height without taking into account outer sep
        \pgf@x=\wd\pgfnodeparttextbox
        \pgf@xc=\pgfkeysvalueof{/pgf/inner xsep}
        \advance\pgf@x by 2\pgf@xc
        \pgf@xc=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xc>\pgf@x
            \pgf@x=\pgf@xc
        \fi
        \pgf@y=\ht\pgfnodeparttextbox
        \advance\pgf@y by \dp\pgfnodeparttextbox
        \pgf@yc=\pgfkeysvalueof{/pgf/inner ysep}
        \advance\pgf@y by 2\pgf@yc
        \pgf@yc=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yc>\pgf@y
            \pgf@y=\pgf@yc
        \fi
        %store south west in xa,ya and north east in xb,yb
        \pgf@xa=-0.5\pgf@x
        \advance\pgf@xa by 0.5\wd\pgfnodeparttextbox
        \pgf@ya=-0.5\pgf@y
        \advance\pgf@ya by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@ya by -0.5\dp\pgfnodeparttextbox
        \pgf@xb=0.5\pgf@x
        \advance\pgf@xb by 0.5\wd\pgfnodeparttextbox
        \pgf@yb=0.5\pgf@y
        \advance\pgf@yb by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@yb by -0.5\dp\pgfnodeparttextbox
        %compute anchor
        \pgf@y=0.5\pgf@yb
        \advance\pgf@y by 0.5\pgf@ya
        \pgf@x=\pgf@xb
        \ifx\connectors\horizontal
            \advance\pgf@x by \lconnectors\pgf@xb
            \advance\pgf@x by -\lconnectors\pgf@xa
        \fi
    }
    \savedanchor\connectorwest{
        \def\lconnectors{0.75}
        \pgfkeysgetvalue{/pgf/connectors}{\connectors}
        %compute width and height without taking into account outer sep
        \pgf@x=\wd\pgfnodeparttextbox
        \pgf@xc=\pgfkeysvalueof{/pgf/inner xsep}
        \advance\pgf@x by 2\pgf@xc
        \pgf@xc=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xc>\pgf@x
            \pgf@x=\pgf@xc
        \fi
        \pgf@y=\ht\pgfnodeparttextbox
        \advance\pgf@y by \dp\pgfnodeparttextbox
        \pgf@yc=\pgfkeysvalueof{/pgf/inner ysep}
        \advance\pgf@y by 2\pgf@yc
        \pgf@yc=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yc>\pgf@y
            \pgf@y=\pgf@yc
        \fi
        %store south west in xa,ya and north east in xb,yb
        \pgf@xa=-0.5\pgf@x
        \advance\pgf@xa by 0.5\wd\pgfnodeparttextbox
        \pgf@ya=-0.5\pgf@y
        \advance\pgf@ya by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@ya by -0.5\dp\pgfnodeparttextbox
        \pgf@xb=0.5\pgf@x
        \advance\pgf@xb by 0.5\wd\pgfnodeparttextbox
        \pgf@yb=0.5\pgf@y
        \advance\pgf@yb by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@yb by -0.5\dp\pgfnodeparttextbox
        %compute anchor
        \pgf@y=0.5\pgf@yb
        \advance\pgf@y by 0.5\pgf@ya
        \pgf@x=\pgf@xa
        \ifx\connectors\horizontal
            \advance\pgf@x by -\lconnectors\pgf@xb
            \advance\pgf@x by \lconnectors\pgf@xa
        \fi
    }
    \savedanchor\connectornorth{
        \def\lconnectors{0.75}
        \pgfkeysgetvalue{/pgf/connectors}{\connectors}
        %compute width and height without taking into account outer sep
        \pgf@x=\wd\pgfnodeparttextbox
        \pgf@xc=\pgfkeysvalueof{/pgf/inner xsep}
        \advance\pgf@x by 2\pgf@xc
        \pgf@xc=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xc>\pgf@x
            \pgf@x=\pgf@xc
        \fi
        \pgf@y=\ht\pgfnodeparttextbox
        \advance\pgf@y by \dp\pgfnodeparttextbox
        \pgf@yc=\pgfkeysvalueof{/pgf/inner ysep}
        \advance\pgf@y by 2\pgf@yc
        \pgf@yc=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yc>\pgf@y
            \pgf@y=\pgf@yc
        \fi
        %store south west in xa,ya and north east in xb,yb
        \pgf@xa=-0.5\pgf@x
        \advance\pgf@xa by 0.5\wd\pgfnodeparttextbox
        \pgf@ya=-0.5\pgf@y
        \advance\pgf@ya by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@ya by -0.5\dp\pgfnodeparttextbox
        \pgf@xb=0.5\pgf@x
        \advance\pgf@xb by 0.5\wd\pgfnodeparttextbox
        \pgf@yb=0.5\pgf@y
        \advance\pgf@yb by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@yb by -0.5\dp\pgfnodeparttextbox
        %compute anchor
        \pgf@x=0.5\pgf@xb
        \advance\pgf@x by 0.5\pgf@xa
        \pgf@y=\pgf@yb
        \ifx\connectors\vertical
            \advance\pgf@y by \lconnectors\pgf@yb
            % \pgftext{\the\pgf@x}
            \advance\pgf@y by -\lconnectors\pgf@ya
        \fi
    }
    \savedanchor\connectorsouth{
        \def\lconnectors{0.75}
        \pgfkeysgetvalue{/pgf/connectors}{\lconnectors}
        %compute width and height without taking into account outer sep
        \pgf@x=\wd\pgfnodeparttextbox
        \pgf@xc=\pgfkeysvalueof{/pgf/inner xsep}
        \advance\pgf@x by 2\pgf@xc
        \pgf@xc=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xc>\pgf@x
            \pgf@x=\pgf@xc
        \fi
        \pgf@y=\ht\pgfnodeparttextbox
        \advance\pgf@y by \dp\pgfnodeparttextbox
        \pgf@yc=\pgfkeysvalueof{/pgf/inner ysep}
        \advance\pgf@y by 2\pgf@yc
        \pgf@yc=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yc>\pgf@y
            \pgf@y=\pgf@yc
        \fi
        %store south west in xa,ya and north east in xb,yb
        \pgf@xa=-0.5\pgf@x
        \advance\pgf@xa by 0.5\wd\pgfnodeparttextbox
        \pgf@ya=-0.5\pgf@y
        \advance\pgf@ya by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@ya by -0.5\dp\pgfnodeparttextbox
        \pgf@xb=0.5\pgf@x
        \advance\pgf@xb by 0.5\wd\pgfnodeparttextbox
        \pgf@yb=0.5\pgf@y
        \advance\pgf@yb by 0.5\ht\pgfnodeparttextbox
        \advance\pgf@yb by -0.5\dp\pgfnodeparttextbox
        %compute anchor
        \pgf@x=0.5\pgf@xb
        \advance\pgf@x by 0.5\pgf@xa
        \pgf@y=\pgf@ya
        \ifx\connectors\vertical
            \advance\pgf@y by -\lconnectors\pgf@yb
            \advance\pgf@y by +\lconnectors\pgf@ya
        \fi
    }
    \anchor{west}{\connectorwest}
    \anchor{east}{\connectoreast}
    \anchor{north}{\connectornorth}
    \anchor{south}{\connectorsouth}

    \backgroundpath{
        \def\lconnectors{0.75}
        \pgfpathrectanglecorners{\southwest}{\northeast}
        \pgfkeysgetvalue{/pgf/connectors}{\connectors}
        \ifx\connectors\horizontal
            \pgf@process{\southwest}
            \pgf@xa = \pgf@x
            \pgf@ya = \pgf@y
            \pgf@process{\northeast}
            \pgf@xb = \pgf@x
            \pgf@yb = \pgf@y
            \pgf@xc=\pgf@x
            \pgf@yc=\pgf@y
            \advance\pgf@yc by -0.5\pgf@yb
            \advance\pgf@yc by 0.5\pgf@ya
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \advance\pgf@xc by \lconnectors\pgf@xb
            \advance\pgf@xc by -\lconnectors\pgf@xa
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc=\pgf@xa
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \advance\pgf@xc by -\lconnectors\pgf@xb
            \advance\pgf@xc by \lconnectors\pgf@xa
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \fi
        \ifx\connectors\vertical
            \pgf@process{\southwest}
            \pgf@xa = \pgf@x
            \pgf@ya = \pgf@y
            \pgf@process{\northeast}
            \pgf@xb = \pgf@x
            \pgf@yb = \pgf@y
            \pgf@xc=\pgf@x
            \pgf@yc=\pgf@y
            \advance\pgf@xc by -0.5\pgf@xb
            \advance\pgf@xc by 0.5\pgf@xa
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \advance\pgf@yc by \lconnectors\pgf@yb
            \advance\pgf@yc by -\lconnectors\pgf@ya
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@yc=\pgf@ya
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \advance\pgf@yc by -\lconnectors\pgf@yb
            \advance\pgf@yc by \lconnectors\pgf@ya
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \fi
    }
}

\pgfdeclareshape{newellipse}{
    \inheritsavedanchors[from=ellipse]
    \inheritanchorborder[from=ellipse]
    \inheritanchor[from=ellipse]{center}
    \inheritanchor[from=ellipse]{north}
    \inheritanchor[from=ellipse]{south}
    \inheritanchor[from=ellipse]{east}
    \inheritanchor[from=ellipse]{west}
    \anchor{center}{\centerpoint}
    \inheritbackgroundpath[from=ellipse]
    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffset{0.25}
            \newdimen\xa
            \newdimen\ya
            \pgf@process{\centerpoint}
            \xa=\pgf@x
            \ya=\pgf@y
            \newdimen\xb
            \newdimen\yb
            \pgf@process{\radius}
            \xb=\pgf@x
            \yb=\pgf@y
            \advance\xb by -0.5\pgflinewidth
            \advance\yb by -0.5\pgflinewidth
            \newdimen\yc
            \pgfmathsetlength{\yc}{-2*\cloneoffset)*\yb}
            \newdimen\xc
            \pgfmathsetlength{\xc}{sqrt(\xb^2-(\xb*\yc/\yb)^2)}
            \newdimen\anglea
            \pgfmathsetmacro{\anglea}{asin(\yc/\yb)}
            \newdimen\angleb
            \pgfmathsetlength{\angleb}{-180-\anglea}
            \pgf@xa = -\xc
            \advance\pgf@xa by \xa
            \pgf@xb = \xc
            \advance\pgf@xb by \xa
            \advance\yc by \ya
            \pgfpathmoveto{\pgfpoint{\pgf@xa}{\yc}}
            \pgfpathlineto{\pgfpoint{\pgf@xb}{\yc}}
            \pgfpatharc{\anglea}{\angleb}{\xb and \yb}
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{stroke, fill}
        \fi
    }
}

\pgfdeclareshape{circlecircle}{
    \inheritsavedanchors[from=circle]
    \inheritanchorborder[from=circle]
    \inheritanchor[from=circle]{center}
    \inheritanchor[from=circle]{north}
    \inheritanchor[from=circle]{south}
    \inheritanchor[from=ellipse]{east}
    \inheritanchor[from=ellipse]{west}
    \anchor{center}{\centerpoint}
    \backgroundpath{
        \pgfpathcircle{\centerpoint}{\radius}
        \pgfpathcircle{\centerpoint}{0.5*\radius}
    }
}

\pgfdeclareshape{circlecrossed}{
    \inheritsavedanchors[from=circle]
    \inheritanchorborder[from=circle]
    \inheritanchor[from=circle]{center}
    \inheritanchor[from=circle]{north}
    \inheritanchor[from=circle]{south}
    \inheritanchor[from=ellipse]{east}
    \inheritanchor[from=ellipse]{west}

    \anchor{center}{\centerpoint}
    \backgroundpath{
        \pgfpathcircle{\centerpoint}{\radius}
        \pgf@process{\centerpoint}
        \pgfgetlastxy{\xa}{\ya}
        \pgfpathmoveto{\pgfpoint{\xa-\radius}{\ya-\radius}}
        \pgfpathlineto{\pgfpoint{\xa+\radius}{\ya+\radius}}
    }
    \foregroundpath{
        \pgf@process{\centerpoint}
        \pgfgetlastxy{\xa}{\ya}
        \pgfpathmoveto{\pgfpoint{\xa-\radius}{\ya-\radius}}
        \pgfpathlineto{\pgfpoint{\xa+\radius}{\ya+\radius}}
    }
}

\pgfdeclareshape{roundedrectangle}{

    \savedanchor\northeast{
        \pgfmathsetlength{\pgf@x}{\wd\pgfnodeparttextbox+2*\pgfkeysvalueof{/pgf/inner xsep}}
        \pgf@xb=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xb>\pgf@x
            \pgf@x=\pgf@xb
        \fi
        \pgfmathsetlength{\pgf@y}{\ht\pgfnodeparttextbox+\dp\pgfnodeparttextbox+2*\pgfkeysvalueof{/pgf/inner ysep}}
        \pgf@yb=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yb>\pgf@y
            \pgf@y=\pgf@yb
        \fi
        \ifdim\pgf@y>\pgf@x
            \pgf@x=\pgf@y
        \fi
        \pgfmathsetlength{\pgf@x}{0.5\pgf@x+0.5\wd\pgfnodeparttextbox}
        \pgfmathsetlength{\pgf@y}{0.5\pgf@y+0.5\ht\pgfnodeparttextbox-0.5\dp\pgfnodeparttextbox+\pgfkeysvalueof{/pgf/outer ysep}}
    }

    \savedanchor\southwest{
        \pgfmathsetlength{\pgf@x}{\wd\pgfnodeparttextbox+2*\pgfkeysvalueof{/pgf/inner xsep}}
        \pgf@xb=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xb>\pgf@x
            \pgf@x=\pgf@xb
        \fi
        \pgfmathsetlength{\pgf@y}{\ht\pgfnodeparttextbox+\dp\pgfnodeparttextbox+2*\pgfkeysvalueof{/pgf/inner ysep}}
        \pgf@yb=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yb>\pgf@y
            \pgf@y=\pgf@yb
        \fi
        \ifdim\pgf@y>\pgf@x
            \pgf@x=\pgf@y
        \fi
        \pgfmathsetlength{\pgf@x}{-0.5\pgf@x+0.5\wd\pgfnodeparttextbox}
        \pgfmathsetlength{\pgf@y}{-0.5\pgf@y+0.5\ht\pgfnodeparttextbox-0.5\dp\pgfnodeparttextbox-\pgfkeysvalueof{/pgf/outer ysep}}
    }

    \foreach \a in {center, north, south, west, east, south east, south west, north east, north west}
    {
        \inheritanchor[from=rectangle]{\a}
    }

    \anchorborder{
        \belongstocone{\pgfpoint{36pt}{36pt}}{1}{1}{1}
        \newdimen\xa
        \newdimen\ya
        \newdimen\xb
        \newdimen\yb
        \newdimen\radius
        \@tempdima=\pgf@x
        \@tempdimb=\pgf@y
        \southwest
        \xa=\pgf@x
        \ya=\pgf@y
        \northeast
        \xb=\pgf@x
        \yb=\pgf@y
        \radius=0.5\ya
        \advance\radius by 0.5\yb
        %compute the center
        \pgf@xc=\pgf@xa
        \advance\pgf@xc by 0.5\pgf@xb
        \pgf@yc=0.5\pgf@ya
        \advance\pgf@yc by 0.5\pgf@yb
        \pgf@xa=\xa
        \advance\pgf@xa by \radius
        \pgf@xb=\xb
        \advance\pgf@xb by \radius
        \pgf@ya=\ya
        \pgf@yb=\yb
        %coordinates relative to the center
        \advance\pgf@xa by -\pgf@xc
        \advance\pgf@xb by -\pgf@xc
        \advance\pgf@ya by -\pgf@yc
        \advance\pgf@yb by -\pgf@yc
        \advance\@tempdima by -\pgf@xc
        \advance\@tempdimb by -\pgf@yc
        %ratios
        \pgf@xc=\pgf@ya
        \divide\pgf@xc by \pgf@xa
        \pgf@yc=\pgf@yb
        \divide\pgf@yc by \pgf@xa
        \pgf@x=\@tempdimb
        % \pgftext{\the\@tempdima}
        % \divide\pgf@x by \@tempdima
    }


    % \inheritanchorborder[from=rectangle]

    \backgroundpath{
        \pgf@process{\southwest}
        \pgf@xa=\pgf@x
        \pgf@ya=\pgf@y
        \pgfmathsetlength{\pgf@xc}{\pgfkeysvalueof{/pgf/outer xsep}}
        \pgfmathsetlength{\pgf@yc}{\pgfkeysvalueof{/pgf/outer ysep}}
        \advance\pgf@xa by \pgf@xc
        \advance\pgf@ya by \pgf@yc
        \pgf@process{\northeast}
        \pgf@xb=\pgf@x
        \pgf@yb=\pgf@y
        \advance\pgf@xb by-1\pgf@xc
        \advance\pgf@yb by-1\pgf@yc
        \newdimen\radius
        \pgfmathsetlength{\radius}{0.5*(\pgf@yb-\pgf@ya)}
        % \advance\radius by -0.5\pgflinewidth
        \advance\pgf@xa by \radius
        \advance\pgf@xb by -\radius
        \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
        \pgfpatharc{90}{-90}{\radius}
        \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@ya}}
        \pgfpatharc{270}{90}{\radius}
        \pgfpathclose
    }

    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffset{0.25}
            \pgf@process{\southwest}
            \pgf@xa=\pgf@x
            \pgf@ya=\pgf@y
            \advance\pgf@xa by 0.5\pgflinewidth
            \advance\pgf@ya by 0.5\pgflinewidth
            \pgf@process{\northeast}
            \pgf@xb=\pgf@x
            \pgf@yb=\pgf@y
            \advance\pgf@xb by -0.5\pgflinewidth
            \advance\pgf@yb by -0.5\pgflinewidth
            \newdimen\radius
            \pgfmathsetlength{\radius}{0.5*(\pgf@yb-\pgf@ya)}
            \pgfmathsetlength{\pgf@yc}{2*\cloneoffset*\radius-\radius}
            \pgfmathsetlength{\pgf@xc}{sqrt(\radius^2-\pgf@yc^2)}
            \pgfmathsetlength{\pgf@yc}{\pgf@ya+\cloneoffset*(\pgf@yb-\pgf@ya)}
            \pgfmathsetlength{\pgf@x}{\pgf@xa+\radius-\pgf@xc}
            \pgfpathmoveto{\pgfpoint{\pgf@x}{\pgf@yc}}
            \pgfmathsetlength{\pgf@x}{\pgf@xb-\radius+\pgf@xc}
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{round(atan2(2*\cloneoffset*\radius-\radius,sqrt(\radius^2-(2*\cloneoffset*\radius-\radius)^2))}
            \pgfpatharc{\pgf@xc}{-90}{\radius}
            \pgfmathsetlength{\pgf@x}{\pgf@xa+\radius}
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@ya}}
            \pgfmathsetlength{\pgf@xc}{-180-\pgf@xc}
            \pgfpatharc{-90}{\pgf@xc}{\radius}
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{stroke, fill}
        \fi
    }
}

\pgfdeclareshape{roundedrectanglestacked}{

    \savedanchor\northeast{
        \pgfmathsetlength{\pgf@x}{\wd\pgfnodeparttextbox+2*\pgfkeysvalueof{/pgf/inner xsep}}
        \pgf@xb=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xb>\pgf@x
            \pgf@x=\pgf@xb
        \fi
        \pgfmathsetlength{\pgf@y}{\ht\pgfnodeparttextbox+\dp\pgfnodeparttextbox+2*\pgfkeysvalueof{/pgf/inner ysep}}
        \pgf@yb=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yb>\pgf@y
            \pgf@y=\pgf@yb
        \fi
        \ifdim\pgf@y>\pgf@x
            \pgf@x=\pgf@y
        \fi
        \pgfmathsetlength{\pgf@x}{0.5\pgf@x+0.5\wd\pgfnodeparttextbox}
        \pgfmathsetlength{\pgf@y}{0.5\pgf@y+0.5\ht\pgfnodeparttextbox-0.5\dp\pgfnodeparttextbox+\pgfkeysvalueof{/pgf/outer ysep}}
    }

    \savedanchor\southwest{
        \pgfmathsetlength{\pgf@x}{\wd\pgfnodeparttextbox+2*\pgfkeysvalueof{/pgf/inner xsep}}
        \pgf@xb=\pgfkeysvalueof{/pgf/minimum width}
        \ifdim\pgf@xb>\pgf@x
            \pgf@x=\pgf@xb
        \fi
        \pgfmathsetlength{\pgf@y}{\ht\pgfnodeparttextbox+\dp\pgfnodeparttextbox+2*\pgfkeysvalueof{/pgf/inner ysep}}
        \pgf@yb=\pgfkeysvalueof{/pgf/minimum height}
        \ifdim\pgf@yb>\pgf@y
            \pgf@y=\pgf@yb
        \fi
        \ifdim\pgf@y>\pgf@x
            \pgf@x=\pgf@y
        \fi
        \pgfmathsetlength{\pgf@x}{-0.5\pgf@x+0.5\wd\pgfnodeparttextbox}
        \pgfmathsetlength{\pgf@y}{-0.5\pgf@y+0.5\ht\pgfnodeparttextbox-0.5\dp\pgfnodeparttextbox-\pgfkeysvalueof{/pgf/outer ysep}}
    }

    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{east}
    \inheritanchor[from=rectangle]{west}
    \inheritanchor[from=rectangle]{south}

    \backgroundpath{
        \def\offset{0.1}
        \newdimen\xa
        \newdimen\ya
        \newdimen\xb
        \newdimen\yb
        \pgf@process{\southwest}
        \xa=\pgf@x
        \ya=\pgf@y
        \pgf@process{\northeast}
        \xb=\pgf@x
        \yb=\pgf@y
        \advance\xa by 0.5\pgflinewidth
        \advance\ya by 0.5\pgflinewidth
        \advance\xb by 0.5\pgflinewidth
        \advance\yb by 0.5\pgflinewidth
        \newdimen\width
        \pgfmathsetlength{\width}{\xb-\xa-\offset*(\yb-\ya)}
        \newdimen\height
        \pgfmathsetlength{\height}{(1-\offset)*(\yb-\ya)}
        \newdimen\radius
        \pgfmathsetlength{\radius}{0.5*\height}
        \pgfmathsetlength{\pgf@xc}{\xa+\radius}
        \pgf@yc=\yb
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\width-\radius}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfpatharc{90}{-90}{\radius}
        \pgfmathsetlength{\pgf@xc}{\xa+\radius}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfpatharc{270}{90}{\radius}
        \pgfpathclose

        \pgfmathsetlength{\pgf@xa}{\xa+\radius}
        \pgfmathsetlength{\pgf@ya}{\yb-\radius}
        \pgfmathsetlength{\pgf@xb}{\xa+\radius+\offset*(\yb-\ya)}
        \pgfmathsetlength{\pgf@yb}{\ya+\radius}
        \pgf@process{\pgfpointintersectionofcircles{\pgfpoint{\pgf@xa}{\pgf@ya}}{\pgfpoint{\pgf@xb}{\pgf@yb}}{\radius}{\radius}{1}}
        \newdimen\ax
        \newdimen\ay
        \ax=\pgf@x
        \ay=\pgf@y
        \pgfpathmoveto{\pgfpoint{\ax}{\ay}}
        \pgf@xc=\ax
        \pgf@yc=\ay
        \advance\pgf@xc by -\pgf@xb
        \advance\pgf@yc by -\pgf@yb
        \newdimen\anglea
        \pgfmathsetlength{\anglea}{atan2(\pgf@yc,\pgf@xc)}
        \pgfpatharc{\anglea}{-90}{\radius}
        \pgfmathsetlength{\pgf@xc}{\xb-\radius}
        \pgf@yc=\ya
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xa}{\xa+\width-\radius}
        \pgfmathsetlength{\pgf@ya}{\yb-\radius}
        \pgfmathsetlength{\pgf@xb}{\xb-\radius}
        \pgfmathsetlength{\pgf@yb}{\ya+\radius}
        \pgf@process{\pgfpointintersectionofcircles{\pgfpoint{\pgf@xa}{\pgf@ya}}{\pgfpoint{\pgf@xb}{\pgf@yb}}{\radius}{\radius}{2}}
        \newdimen\bx
        \newdimen\by
        \bx=\pgf@x
        \by=\pgf@y
        \pgf@xc=\bx
        \pgf@yc=\by
        \advance\pgf@xc by -\pgf@xb
        \advance\pgf@yc by -\pgf@yb
        \pgfmathsetlength{\anglea}{atan2(\pgf@yc,\pgf@xc)}
        \pgfpatharc{-90}{\anglea}{\radius}
        \pgf@xc=\bx
        \pgf@yc=\by
        \advance\pgf@xc by -\xa
        \advance\pgf@xc by -\width
        \advance\pgf@xc by \radius
        \advance\pgf@yc by -\pgf@ya
        \pgfmathsetlength{\anglea}{atan2(\pgf@yc,\pgf@xc)}
        \pgfpatharc{\anglea}{-90}{\radius}
        \pgfmathsetlength{\pgf@xc}{\xa+\radius}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc=\ax
        \pgf@yc=\ay
        \advance\pgf@xc by -\xa
        \advance\pgf@xc by -\radius
        \advance\pgf@yc by -\pgf@ya
        \newdimen\anglea
        \pgfmathsetlength{\anglea}{atan2(\pgf@yc,\pgf@xc)}
        \pgfpatharc{-90}{\anglea}{\radius}
        \pgfpathclose
    }

    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffset{0.25}
            \def\offset{0.1}
            \newdimen\xa
            \newdimen\ya
            \newdimen\xb
            \newdimen\yb
            \pgf@process{\southwest}
            \xa=\pgf@x
            \ya=\pgf@y
            \pgf@process{\northeast}
            \xb=\pgf@x
            \yb=\pgf@y
            \advance\xa by 0.5\pgflinewidth
            \advance\ya by 0.5\pgflinewidth
            \advance\xb by 0.5\pgflinewidth
            \advance\yb by 0.5\pgflinewidth
            \newdimen\width
            \pgfmathsetlength{\width}{\xb-\xa-\offset*(\yb-\ya)}
            \newdimen\height
            \pgfmathsetlength{\height}{(1-\offset)*(\yb-\ya)}
            \newdimen\radius
            \pgfmathsetlength{\radius}{0.5*\height}
            \newdimen\cax
            \newdimen\cay
            \newdimen\cbx
            \newdimen\cby
            \newdimen\ccx
            \newdimen\ccy
            \newdimen\cdx
            \newdimen\cdy
            \pgfmathsetlength{\cax}{\xa+\radius}
            \pgfmathsetlength{\cay}{\yb-\radius}
            \pgfmathsetlength{\cbx}{\xa+\width-\radius}
            \pgfmathsetlength{\cby}{\yb-\radius}
            \pgfmathsetlength{\ccx}{\cax+\offset*(\yb-\ya)}
            \pgfmathsetlength{\ccy}{\ya+\radius}
            \pgfmathsetlength{\cdx}{\xb-\radius}
            \pgfmathsetlength{\cdy}{\ya+\radius}

            \pgf@yc=\yb
            \advance\pgf@yc by -\height
            \advance\pgf@yc by \cloneoffset\height
            \circlefindx{\cax}{\cay}{\radius}{\pgf@yc}{1}
            \pgfpathmoveto{\pgfpoint{\pgf@x}{\pgf@yc}}
            \circlefindx{\cbx}{\cby}{\radius}{\pgf@yc}{2}
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@yc}}
            \circlefindangle{\cbx}{\cby}{\radius}{\pgf@yc}{2}
            \pgfpatharc{\pgf@x}{-90}{\radius}
            \pgf@y=\yb
            \advance\pgf@y by -\height
            \pgf@x=\xa
            \advance\pgf@x by \radius
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@y}}
            \circlefindangle{\cax}{\cay}{\radius}{\pgf@yc}{1}
            \pgfpatharc{-90}{\pgf@x}{\radius}
            \pgfpathclose

            \pgfpointintersectionofcircles{\pgfpoint{\cax}{\cay}}{\pgfpoint{\ccx}{\ccy}}{\radius}{\radius}{1}
            \pgf@yb=\pgf@y
            \pgfpathmoveto{\pgfpoint{\pgf@x}{\pgf@yb}}
            \circlefindangle{\ccx}{\ccy}{\radius}{\pgf@yb}{1}
            \pgfpatharc{\pgf@x}{-90}{\radius}
            \pgf@x=\xb
            \advance\pgf@x by -\radius
            \pgf@y=\ya
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@y}}
            \pgf@yc=\ya
            \advance\pgf@yc by \cloneoffset\height
            \circlefindangle{\cdx}{\cdy}{\radius}{\pgf@yc}{2}
            \pgfpatharc{-90}{\pgf@x}{\radius}
            \circlefindx{\cbx}{\cby}{\radius}{\pgf@yc}{2}
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@yc}}
            \circlefindangle{\cbx}{\cby}{\radius}{\pgf@yc}{2}
            \pgfpatharc{\pgf@x}{-90}{\radius}
            \pgf@x=\xa
            \advance\pgf@x by \radius
            \pgf@y=\yb
            \advance\pgf@y by -\height
            \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@y}}
            \circlefindangle{\cax}{\cay}{\radius}{\pgf@yb}{1}
            \pgfpatharc{-90}{\pgf@x}{\radius}
            \pgfpathclose

            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{fill, stroke}
        \fi
    }
}
\pgfdeclareshape{circleand}{
    \inheritsavedanchors[from=circle]
    \inheritanchorborder[from=circle]
    \inheritanchor[from=circle]{center}
    \inheritanchor[from=circle]{north}
    \inheritanchor[from=circle]{south}
    \inheritanchor[from=ellipse]{east}
    \inheritanchor[from=ellipse]{west}

    \anchor{center}{\centerpoint}
    \backgroundpath{
        \pgfpathcircle{\centerpoint}{\radius}
    }
    \foregroundpath{
        \centerpoint
        \pgftext{\small\sffamily\textcolor{\tikz@strokecolor}{AND}}
    }
}

\pgfdeclareshape{circleor}{
    \inheritsavedanchors[from=circle]
    \inheritanchorborder[from=circle]
    \inheritanchor[from=circle]{center}
    \inheritanchor[from=circle]{north}
    \inheritanchor[from=circle]{south}
    \inheritanchor[from=circle]{east}
    \inheritanchor[from=circle]{west}
    \anchor{center}{\centerpoint}
    \backgroundpath{
        \pgfpathcircle{\centerpoint}{\radius}
    }
    \foregroundpath{
        \centerpoint
        \pgftext{\small\sffamily\textcolor{\tikz@strokecolor}{OR}}
    }
}

\pgfdeclareshape{circlenot}{
    \inheritsavedanchors[from=circle]
    \inheritanchorborder[from=circle]
    \inheritanchor[from=circle]{center}
    \inheritanchor[from=circle]{north}
    \inheritanchor[from=circle]{south}
    \inheritanchor[from=circle]{east}
    \inheritanchor[from=circle]{west}
    \anchor{center}{\centerpoint}
    \backgroundpath{
        \pgfpathcircle{\centerpoint}{\radius}
    }
    \foregroundpath{
        \centerpoint
        \pgftext{\small\sffamily\textcolor{\tikz@strokecolor}{NOT}}
    }
}

\pgfdeclareshape{circletau}{
    \inheritsavedanchors[from=circle]
    \inheritanchorborder[from=circle]
    \inheritanchor[from=circle]{center}
    \inheritanchor[from=circle]{north}
    \inheritanchor[from=circle]{south}
    \inheritanchor[from=circle]{east}
    \inheritanchor[from=circle]{west}
    \anchor{center}{\centerpoint}
    \backgroundpath{
        \pgfpathcircle{\centerpoint}{\radius}
    }
    \foregroundpath{
        % \centerpoint
        \pgftext{\Huge\sffamily\textcolor{\tikz@strokecolor}{$\tau$}}
    }
}

\pgfdeclareshape{rectangleslashslash}{
    \inheritsavedanchors[from=rectangle]
    \inheritanchorborder[from=rectangle]
    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{south}
    \inheritanchor[from=rectangle]{east}
    \inheritanchor[from=rectangle]{west}
    \backgroundpath{
        \pgfpathrectanglecorners{\southwest}{\northeast}
    }
    \foregroundpath{
        \pgf@process{\southwest}
        \pgfgetlastxy{\xa}{\ya}
        \pgf@process{\northeast}
        \pgfgetlastxy{\xb}{\yb}
        \pgfmathsetlength{\pgf@xc}{\xa+0.25*(\xb-\xa)}
        \pgfmathsetlength{\pgf@yc}{\yb-0.1*(\yb-\ya)}
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+0.5*(\xb-\xa)}
        \pgfmathsetlength{\pgf@yc}{\ya+0.1*(\yb-\ya)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+0.5*(\xb-\xa)}
        \pgfmathsetlength{\pgf@yc}{\yb-0.1*(\yb-\ya)}
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+0.75*(\xb-\xa)}
        \pgfmathsetlength{\pgf@yc}{\ya+0.1*(\yb-\ya)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfusepath{stroke}
    }
}

\pgfdeclareshape{rectangleinterrogation}{
    \inheritsavedanchors[from=rectangle]
    \inheritanchorborder[from=rectangle]
    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{south}
    \inheritanchor[from=rectangle]{east}
    \inheritanchor[from=rectangle]{west}

    \backgroundpath{
        \pgfpathrectanglecorners{\southwest}{\northeast}
    }
    \foregroundpath{
        % \pgf@process{\southwest}
        % \pgfgetlastxy{\xa}{\ya}
        % \pgf@process{\northeast}
        % \pgfgetlastxy{\xb}{\yb}
        % \pgfmathsetlength{\pgf@x}{0.5*(\xb-\xa)}
        % \pgfmathsetlength{\pgf@y}{0.5*(\yb-\ya)}
        \pgftext{\sffamily\textcolor{black}{\textbf{?}}}
    }
}

\pgfdeclareshape{rectanglecutcorners}{
    \inheritsavedanchors[from=rectangle] % this is nearly a rectangle
    \inheritanchorborder[from=rectangle]
    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{south}
    \inheritanchor[from=rectangle]{west}
    \inheritanchor[from=rectangle]{east}
    \backgroundpath{
        \def\cut{0.1}
        \pgf@process{\southwest}
        \pgfgetlastxy{\xa}{\ya}
        \pgf@process{\northeast}
        \pgfgetlastxy{\xb}{\yb}
        \newdimen\width
        \pgfmathsetlength{\width}{\xb-\xa}
        \newdimen\height
        \pgfmathsetlength{\height}{\yb-\ya}

        \pgfmathsetlength{\pgf@xc}{\xa+\cut*\width}
        \pgf@yc=\yb
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+(1-\cut)*(\width)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\width}
        \pgfmathsetlength{\pgf@yc}{\yb-\cut*\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-(1-\cut)*\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+(1-\cut)*(\width)}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\cut*(\width)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-(1-\cut)*\height}
        \pgf@xc = \xa
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-\cut*\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfpathclose
    }
    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffset{0.25}
            \pgf@process{\southwest}
            \pgfgetlastxy{\xa}{\ya}
            \pgf@process{\northeast}
            \pgfgetlastxy{\xb}{\yb}
            \newdimen\width
            \pgfmathsetlength{\width}{\xb-\xa}
            \newdimen\height
            \pgfmathsetlength{\height}{\yb-\ya}

            \pgf@xc=\xa
            \pgfmathsetlength{\pgf@yc}{\ya+\cloneoffset*\height}
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc=\xb
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@yc}{\yb-(1-\cut)*\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+(1-\cut)*(\width)}
            \pgfmathsetlength{\pgf@yc}{\yb-\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+\cut*(\width)}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@yc}{\yb-(1-\cut)*\height}
            \pgf@xc = \xa
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{stroke, fill}
        \fi
    }

}

\pgfdeclareshape{rectanglecutcornersstacked}{
    \inheritsavedanchors[from=rectangle]
    \inheritanchorborder[from=rectangle]
    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{south}
    \inheritanchor[from=rectangle]{west}
    \inheritanchor[from=rectangle]{east}
    \backgroundpath{
        \def\cut{0.1}
        \def\offset{0.1}
        \pgf@process{\southwest}
        \pgfgetlastxy{\xa}{\ya}
        \pgf@process{\northeast}
        \pgfgetlastxy{\xb}{\yb}
        \newdimen\width
        \pgfmathsetlength{\width}{\xb-\xa-\offset*(\yb-\ya)}
        \newdimen\height
        \pgfmathsetlength{\height}{(1-\offset)*(\yb-\ya)}

        \pgfmathsetlength{\pgf@xc}{\xa+\cut*\width}
        \pgf@yc=\yb
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+(1-\cut)*(\width)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\width}
        \pgfmathsetlength{\pgf@yc}{\yb-\cut*\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-(1-\cut)*\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+(1-\cut)*(\width)}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\cut*(\width)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-(1-\cut)*\height}
        \pgf@xc = \xa
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-\cut*\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfpathclose

        \pgfmathsetlength{\pgf@xc}{\xb-\width}
        \pgfmathsetlength{\pgf@yc}{\yb-\height+\cut*\height-\offset*(\yb-\ya)/\width*\height}
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\ya+\cut*\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xb-\width+\cut*\width}
        \pgf@yc=\ya
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xb-\cut*\width}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc=\xb
        \pgfmathsetlength{\pgf@yc}{\ya+\cut*\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\ya+(1-\cut)*\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\width}
        \pgfmathsetlength{\pgf@yc}{\ya+(1-\cut)*\height+\cut*\height-\height*(\cut*\width-\offset*(\yb-\ya))/\width}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-(1-\cut)*\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+(1-\cut)*(\width)}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\cut*(\width)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfpathclose
    }
    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffset{0.25}
            \def\cut{0.1}
            \def\offset{0.1}
            \pgf@process{\southwest}
            \pgfgetlastxy{\xa}{\ya}
            \pgf@process{\northeast}
            \pgfgetlastxy{\xb}{\yb}
            \newdimen\width
            \pgfmathsetlength{\width}{\xb-\xa-\offset*(\yb-\ya)}
            \newdimen\height
            \pgfmathsetlength{\height}{(1-\offset)*(\yb-\ya)}

            \pgf@xc=\xa
            \pgfmathsetlength{\pgf@yc}{\yb-(1-\cloneoffset)*(\height)}
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+\width}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@yc}{\yb-(1-\cut)*\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+(1-\cut)*(\width)}
            \pgfmathsetlength{\pgf@yc}{\yb-\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+\cut*(\width)}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@yc}{\yb-(1-\cut)*\height}
            \pgf@xc = \xa
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfpathclose

            \pgfmathsetlength{\pgf@xc}{\xb-\width}
            \pgfmathsetlength{\pgf@yc}{\yb-\height+\cut*\height-\offset*(\yb-\ya)/\width*\height}
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@yc}{\ya+\cut*\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xb-\width+\cut*\width}
            \pgf@yc=\ya
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xb-\cut*\width}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc=\xb
            \pgfmathsetlength{\pgf@yc}{\ya+\cut*\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@yc}{\ya+\cloneoffset*\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+\width}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@yc}{\ya+(1-\cut)*\height+\cut*\height-\height*(\cut*\width-\offset*(\yb-\ya))/\width}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@yc}{\yb-(1-\cut)*\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+(1-\cut)*(\width)}
            \pgfmathsetlength{\pgf@yc}{\yb-\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+\cut*(\width)}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{stroke, fill}
        \fi
    }
}

\pgfdeclareshape{rectangleroundedcorners}{
    \inheritsavedanchors[from=rectangle] % this is nearly a rectangle
    \inheritanchorborder[from=rectangle]
    \foreach \a in {center, north, south, west, east, south east, south west, north east, north west}
    {
        \inheritanchor[from=rectangle]{\a}
    }

    \backgroundpath{
        \def\scarce{0.038}
        \pgf@process{\southwest}
        \pgfgetlastxy{\xa}{\ya}
        \pgf@process{\northeast}
        \pgfgetlastxy{\xb}{\yb}
        \newdimen\width
        \pgfmathsetlength{\width}{\xb-\xa}
        \newdimen\height
        \pgfmathsetlength{\height}{\yb-\ya}

        \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
        \pgf@xc = \xa \pgf@yc = \yb
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\width}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc=\xa
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfpathclose
    }

    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffset{0.25}
            \def\scarce{0.038}
            \pgf@process{\southwest}
            \pgfgetlastxy{\xa}{\ya}
            \pgf@process{\northeast}
            \pgfgetlastxy{\xb}{\yb}
            \newdimen\width
            \pgfmathsetlength{\width}{\xb-\xa}
            \newdimen\height
            \pgfmathsetlength{\height}{\yb-\ya}

            \pgfsetcornersarced{\pgfpointorigin}
            \pgfmathsetlength{\pgf@xc}{\xa}
            \pgfmathsetlength{\pgf@yc}{\ya+\cloneoffset*\height}
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc = \xb
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@yc = \ya
            \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc = \xa
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfsetcornersarced{\pgfpointorigin}
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{stroke, fill}
        \fi
    }
}

\pgfdeclareshape{rectangleroundedcornersstacked}{
    \inheritsavedanchors[from=rectangle] % this is nearly a rectangle
    \inheritanchorborder[from=rectangle]
    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{south}
    \inheritanchor[from=rectangle]{west}
    \inheritanchor[from=rectangle]{east}
    \backgroundpath{
        \def\offset{0.1}
        \def\scarce{0.038}
        \pgf@process{\southwest}
        \pgfgetlastxy{\xa}{\ya}
        \pgf@process{\northeast}
        \pgfgetlastxy{\xb}{\yb}
        \newdimen\width
        \pgfmathsetlength{\width}{\xb-\xa-\offset*(\yb-\ya)}
        \newdimen\height
        \pgfmathsetlength{\height}{(1-\offset)*(\yb-\ya)}

        \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
        \pgf@xc = \xa \pgf@yc = \yb
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\width}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc=\xa
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfpathclose

        \pgfmathsetlength{\pgf@xc}{\xb-\width}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@yc = \ya
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc = \xb
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\ya+\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\width}
        \pgfsetcornersarced{\pgfpointorigin}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfsetcornersarced{\pgfpointorigin}
        \pgfpathclose
    }
    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\offset{0.1}
            \def\cloneoffset{0.25}
            \def\scarce{0.038}
            \pgf@process{\southwest}
            \pgfgetlastxy{\xa}{\ya}
            \pgf@process{\northeast}
            \pgfgetlastxy{\xb}{\yb}
            \newdimen\width
            \pgfmathsetlength{\width}{\xb-\xa-\offset*(\yb-\ya)}
            \newdimen\height
            \pgfmathsetlength{\height}{(1-\offset)*(\yb-\ya)}

            \pgf@xc = \xa
            \pgfmathsetlength{\pgf@yc}{\yb-(1-\cloneoffset)*\height}
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+\width}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
            \pgfmathsetlength{\pgf@yc}{\yb-\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc=\xa
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfsetcornersarced{\pgfpointorigin}
            \pgfpathclose

            \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
            \pgfmathsetlength{\pgf@xc}{\xb-\width}
            \pgfmathsetlength{\pgf@yc}{\yb-\height}
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@yc = \ya
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc = \xb
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfsetcornersarced{\pgfpointorigin}
            \pgfmathsetlength{\pgf@yc}{\ya+\cloneoffset*\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+\width}
            \pgfsetcornersarced{\pgfpointorigin}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@yc}{\yb-\height}
            \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfsetcornersarced{\pgfpointorigin}
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{stroke, fill}
        \fi
    }
}

\pgfdeclareshape{rectangleroundedcornersbottom}{
    \inheritsavedanchors[from=rectangle] % this is nearly a rectangle
    \inheritanchorborder[from=rectangle]
    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{south}
    \inheritanchor[from=rectangle]{west}
    \inheritanchor[from=rectangle]{east}
    \backgroundpath{
        \def\offset{0.1}
        \def\scarce{0.038}
        \pgf@process{\southwest}
        \pgfgetlastxy{\xa}{\ya}
        \pgf@process{\northeast}
        \pgfgetlastxy{\xb}{\yb}
        \newdimen\width
        \pgfmathsetlength{\width}{\xb-\xa}
        \newdimen\height
        \pgfmathsetlength{\height}{\yb-\ya}

        \pgf@xc = \xa \pgf@yc = \yb
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\width}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc=\xa
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfsetcornersarced{\pgfpointorigin}
        \pgfpathclose
    }
    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\cloneoffset{0.25}
            \def\scarce{0.038}
            \pgf@process{\southwest}
            \pgfgetlastxy{\xa}{\ya}
            \pgf@process{\northeast}
            \pgfgetlastxy{\xb}{\yb}
            \newdimen\width
            \pgfmathsetlength{\width}{\xb-\xa}
            \newdimen\height
            \pgfmathsetlength{\height}{\yb-\ya}

            \pgfsetcornersarced{\pgfpointorigin}
            \pgfmathsetlength{\pgf@xc}{\xa}
            \pgfmathsetlength{\pgf@yc}{\ya+\cloneoffset*\height}
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc = \xb
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@yc = \ya
            \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc = \xa
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfsetcornersarced{\pgfpointorigin}
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{stroke, fill}
        \fi
    }
}

\pgfdeclareshape{rectangleroundedcornersbottomstacked}{
    \inheritsavedanchors[from=rectangle] % this is nearly a rectangle
    \inheritanchorborder[from=rectangle]
    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{south}
    \inheritanchor[from=rectangle]{west}
    \inheritanchor[from=rectangle]{east}
    \backgroundpath{
        \def\offset{0.1}
        \def\scarce{0.038}
        \pgf@process{\southwest}
        \pgfgetlastxy{\xa}{\ya}
        \pgf@process{\northeast}
        \pgfgetlastxy{\xb}{\yb}
        \newdimen\width
        \pgfmathsetlength{\width}{\xb-\xa-\offset*(\yb-\ya)}
        \newdimen\height
        \pgfmathsetlength{\height}{(1-\offset)*(\yb-\ya)}

        \pgf@xc = \xa \pgf@yc = \yb
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\width}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc=\xa
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfsetcornersarced{\pgfpointorigin}
        \pgfpathclose

        \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
        \pgfmathsetlength{\pgf@xc}{\xb-\width}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@yc = \ya
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc = \xb
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfsetcornersarced{\pgfpointorigin}
        \pgfmathsetlength{\pgf@yc}{\ya+\height}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+\width}
        \pgfsetcornersarced{\pgfpointorigin}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\yb-\height}
        \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfsetcornersarced{\pgfpointorigin}
        \pgfpathclose
    }
    \foregroundpath{
        \pgfkeysgetvalue{/pgf/clone}{\clone}
        \ifx\clone\true
            \def\offset{0.1}
            \def\cloneoffset{0.25}
            \def\scarce{0.038}
            \pgf@process{\southwest}
            \pgfgetlastxy{\xa}{\ya}
            \pgf@process{\northeast}
            \pgfgetlastxy{\xb}{\yb}
            \newdimen\width
            \pgfmathsetlength{\width}{\xb-\xa-\offset*(\yb-\ya)}
            \newdimen\height
            \pgfmathsetlength{\height}{(1-\offset)*(\yb-\ya)}

            \pgf@xc = \xa
            \pgfmathsetlength{\pgf@yc}{\yb-(1-\cloneoffset)*\height}
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+\width}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
            \pgfmathsetlength{\pgf@yc}{\yb-\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc=\xa
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfsetcornersarced{\pgfpointorigin}
            \pgfpathclose

            \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
            \pgfmathsetlength{\pgf@xc}{\xb-\width}
            \pgfmathsetlength{\pgf@yc}{\yb-\height}
            \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@yc = \ya
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgf@xc = \xb
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfsetcornersarced{\pgfpointorigin}
            \pgfmathsetlength{\pgf@yc}{\ya+\cloneoffset*\height}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@xc}{\xa+\width}
            \pgfsetcornersarced{\pgfpointorigin}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfmathsetlength{\pgf@yc}{\yb-\height}
            \pgfsetcornersarced{\pgfpoint{\scarce*\width}{\scarce*\width}}
            \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
            \pgfsetcornersarced{\pgfpointorigin}
            \pgfpathclose
            \pgfsetfillcolor{\tikz@strokecolor}
            \pgfusepath{stroke, fill}
        \fi
    }
}

\pgfdeclareshape{rectangleinwardswidth}{
    \inheritsavedanchors[from=rectangle] % this is nearly a rectangle
    \inheritanchorborder[from=rectangle]
    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{south}
    \inheritanchor[from=rectangle]{west}
    \inheritanchor[from=rectangle]{east}
    \backgroundpath{
        \pgf@process{\southwest}
        \pgfgetlastxy{\xa}{\ya}
        \pgf@process{\northeast}
        \pgfgetlastxy{\xb}{\yb}
        \pgf@xc = \xa \pgf@yc = \yb
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc = \xb
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\ya+0.5*(\yb-\ya)}
        \pgfmathsetlength{\pgf@xc}{\xb-0.20*(\xb-\xa)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc = \xb \pgf@yc = \ya
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgf@xc = \xa \pgf@yc = \ya
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\ya+0.5*(\yb-\ya)}
        \pgfmathsetlength{\pgf@xc}{\xa+0.20*(\xb-\xa)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfclosepath
    }
}

\pgfdeclareshape{rectangleoutwardswidth}{
    \inheritsavedanchors[from=rectangle] % this is nearly a rectangle
    \inheritanchorborder[from=rectangle]
    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{south}
    \inheritanchor[from=rectangle]{west}
    \inheritanchor[from=rectangle]{east}
    \backgroundpath{
        \pgf@process{\southwest}
        \pgfgetlastxy{\xa}{\ya}
        \pgf@process{\northeast}
        \pgfgetlastxy{\xb}{\yb}
        \pgf@yc = \yb
        \pgfmathsetlength{\pgf@xc}{\xa+0.20*(\xb-\xa)}
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xb-0.20*(\xb-\xa)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\ya+0.5*(\yb-\ya)}
        \pgf@xc = \xb
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xb-0.20*(\xb-\xa)}
        \pgf@yc = \ya
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@xc}{\xa+0.20*(\xb-\xa)}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfmathsetlength{\pgf@yc}{\ya+0.5*(\yb-\ya)}
        \pgf@xc = \xa
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfclosepath
    }
}


\tikzset{
    font=\sffamily,
    macromolecule/.style={draw = black, shape = rectangleroundedcorners, minimum height = 40pt, minimum width = 80pt, line width = 1pt},
    macromoleculemultimer/.style={draw = black, shape = rectangleroundedcornersstacked, minimum height = 40pt, minimum width = 80pt, line width = 1pt},
    unspecifiedentity/.style={draw = black, shape = newellipse, minimum height = 40pt, minimum width = 80pt, line width = 1pt},
    nucleicacidfeature/.style={draw = black, shape = rectangleroundedcornersbottom, minimum height = 40pt, minimum width = 80pt, line width = 1pt},
    nucleicacidfeaturemultimer/.style={draw = black, shape = rectangleroundedcornersbottomstacked, minimum height = 40pt, minimum width = 80pt, line width = 1pt},
    perturbation/.style={draw = black, shape = rectangleinwardswidth, minimum height = 40pt, minimum width = 80pt, line width = 1pt},
    simplechemical/.style={draw = black, shape = roundedrectangle, minimum height = 35pt, line width = 1pt},
    simplechemicalmultimer/.style={draw = black, shape = roundedrectanglestacked, minimum height = 35pt, minimum width = 80pt, line width = 1pt},
    complex/.style={draw = black, shape = rectanglecutcorners, minimum height = 40pt, minimum width = 80pt, line width = 1pt},
    complexmultimer/.style={draw = black, shape = rectanglecutcornersstacked, minimum height = 40pt, minimum width = 80pt, line width = 1pt},
    emptyset/.style={draw = black, shape = circlecrossed, minimum height = 40pt, minimum width = 40pt, line width = 1pt},
    biologicalactivity/.style={draw = black, shape = rectangle, minimum height = 35pt, minimum width = 60pt, line width = 1pt},
    sv/.style={draw = black, fill = white, shape = rounded rectangle, minimum width = 10pt, minimum height = 10pt, line width = 1pt, font = {\scriptsize\sffamily}},
    ui/.style={draw = black, fill = white, shape = rectangle, line width = 1pt, font = {\scriptsize\sffamily}},
    % ui/.style={draw = black, fill = white, shape = rectangle, line width = 1pt, font = {\scriptsize\sffamily}, inner sep=0.5pt},
    uimacromolecule/.style={draw = black, shape = rectangleroundedcorners, fill = white, line width = 1pt, font = {\tiny\sffamily}},
    uicomplex/.style={draw = black, shape = rectanglecutcorners, fill = white, line width = 1pt, font = {\tiny\sffamily}},
    uiperturbation/.style={draw = black, shape = rectangleinwardswidth, fill = white, line width = 1pt, font = {\tiny\sffamily}},
    uisimplechemical/.style={draw = black, shape = rounded rectangle, fill = white, line width = 1pt, font = {\tiny\sffamily}},
    uinucleicacidfeature/.style={draw = black, shape = rectangleroundedcornersbottom, fill = white, line width = 1pt, font = {\tiny\sffamily}},
    uiunspecifiedentity/.style={draw = black, shape = ellipse, fill = white, line width = 1pt, font = {\tiny\sffamily}},
    compartment/.style={draw = black, line width = 4pt},
    submap/.style={draw = black, shape = rectangle, minimum height = 70pt, minimum width = 100pt, line width = 1pt},
    tag/.style={draw = black, signal, minimum height = 20pt, minimum width = 30pt, line width = 1pt},
    and/.style={draw = black, shape = circleand, minimum height = 20pt, minimum width = 20pt, line width = 1pt},
    or/.style={draw = black, shape = circleor, minimum height = 20pt, minimum width = 20pt, line width = 1pt},
    not/.style={draw = black, shape = circlenot, minimum height = 20pt, minimum width = 20pt, line width = 1pt},
    delay/.style={draw = black, shape = circletau, minimum height = 20pt, minimum width = 20pt, line width = 1pt},
    genericprocess/.style={draw = black, shape = genericprocess, minimum height = 15pt, minimum width = 15pt, line width = 1pt},
    omittedprocess/.style={draw = black, shape = rectangleslashslash, minimum height = 15pt, minimum width = 15pt, line width = 1pt},
    unknownprocess/.style={draw = black, shape = rectangleinterrogation, minimum height = 15pt, minimum width = 15pt, line width = 1pt},
    association/.style={draw = black, fill = black, shape = circle, minimum height = 15pt, minimum width = 15pt, line width = 1pt},
    dissociation/.style={draw = black, shape = circlecircle, minimum height = 15pt, minimum width = 15pt, line width = 1pt},
    phenotype/.style={draw = black, shape = rectangleoutwardswidth, minimum height = 40pt, minimum width = 80pt, line width = 1pt},
    logicarc/.style={line width = 1pt},
    equivalencearc/.style={line width = 1pt},
    consumption/.style={line width = 1pt},
    production/.style={line width = 1pt, -{Triangle[length=6pt, width=8pt]}},
    reversible/.style={line width = 1pt, {Triangle[length=6pt, width=8pt]}-},
    modulation/.style={line width = 1pt, -{Diamond[open, length=9pt, width=9pt]}},
    stimulation/.style={line width = 1pt, -{Triangle[open, length=9pt, width=12pt]}},
    catalysis/.style={line width = 1pt, -{Circle[open, length = 8pt, width=8pt]}},
    inhibition/.style={line width = 1.6pt, -{Bar}},
    absoluteinhibition/.style={line width = 1.6pt, -{Bar[sep=1] Bar}},
    necessarystimulation/.style={line width = 1pt, -{Bar[width = 12pt, sep=1] Triangle[open, length=9pt, width=12pt]}},
    absolutestimulation/.style={line width = 1pt, -{Triangle[fill=white, length=9pt, width=12pt, sep=-3] Triangle[fill=white, length=9pt, width=12pt]}}}
